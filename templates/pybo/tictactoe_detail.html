{% extends 'base.html' %}
{% load common_tags %}

{% block title %}{{ game.title }} - Ìã±ÌÉùÌÜ†{% endblock %}

{% block extra_css %}
<style>
.tictactoe-board {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
    max-width: 400px;
    margin: 0 auto;
    padding: 20px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 15px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
}

.tictactoe-cell {
    aspect-ratio: 1;
    background: white;
    border: none;
    border-radius: 10px;
    font-size: 48px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.tictactoe-cell:hover:not(:disabled) {
    transform: scale(1.05);
    box-shadow: 0 6px 12px rgba(0,0,0,0.2);
}

.tictactoe-cell:disabled {
    cursor: not-allowed;
    opacity: 0.8;
}

.tictactoe-cell.cell-x {
    color: #e74c3c;
    animation: popIn 0.3s ease;
}

.tictactoe-cell.cell-o {
    color: #3498db;
    animation: popIn 0.3s ease;
}

@keyframes popIn {
    0% { transform: scale(0); }
    50% { transform: scale(1.2); }
    100% { transform: scale(1); }
}

.player-info {
    padding: 15px;
    border-radius: 10px;
    margin-bottom: 15px;
    transition: all 0.3s ease;
}

.player-info.active {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    transform: scale(1.05);
    box-shadow: 0 6px 15px rgba(102, 126, 234, 0.4);
}

.player-info:not(.active) {
    background: #f8f9fa;
}

.winner-banner {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(0);
    background: white;
    padding: 40px;
    border-radius: 20px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    z-index: 1000;
    animation: winnerPop 0.5s ease forwards;
}

@keyframes winnerPop {
    to {
        transform: translate(-50%, -50%) scale(1);
    }
}

.overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    z-index: 999;
    display: none;
}

.overlay.show {
    display: block;
}
</style>
{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <!-- Í≤åÏûÑ Ìó§Îçî -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0"><i class="fas fa-gamepad me-2"></i>{{ game.title }}</h3>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="player-info {% if game.status == 'playing' and game.current_turn == 'X' %}active{% endif %}" id="playerXInfo">
                                <h5>
                                    <span class="badge bg-danger me-2">X</span>
                                    {{ game.player_x.username }}
                                    {% if is_player_x %}<small class="text-muted">(ÎÇò)</small>{% endif %}
                                </h5>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="player-info {% if game.status == 'playing' and game.current_turn == 'O' %}active{% endif %}" id="playerOInfo">
                                <h5>
                                    <span class="badge bg-info me-2">O</span>
                                    {% if game.player_o %}
                                        {{ game.player_o.username }}
                                        {% if is_player_o %}<small class="text-muted">(ÎÇò)</small>{% endif %}
                                    {% else %}
                                        <span class="text-muted">ÎåÄÍ∏∞Ï§ë...</span>
                                    {% endif %}
                                </h5>
                            </div>
                        </div>
                    </div>

                    {% if game.status == 'waiting' and can_join %}
                    <div class="text-center mt-3">
                        <button class="btn btn-success btn-lg" onclick="joinGame()">
                            <i class="fas fa-user-plus me-2"></i>Í≤åÏûÑ Ï∞∏Í∞ÄÌïòÍ∏∞
                        </button>
                    </div>
                    {% endif %}

                    {% if game.status == 'waiting' and not can_join and not game.player_o %}
                    <div class="alert alert-info text-center mt-3">
                        <i class="fas fa-clock me-2"></i>ÏÉÅÎåÄÎ∞©ÏùÑ Í∏∞Îã§Î¶¨Îäî Ï§ë...
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Í≤åÏûÑ Î≥¥Îìú -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="tictactoe-board" id="gameBoard">
                        {% for row in game.board_state %}
                            {% for cell in row %}
                                <button class="tictactoe-cell
                                    {% if cell == 'X' %}cell-x{% elif cell == 'O' %}cell-o{% endif %}"
                                    data-row="{{ forloop.parentloop.counter0 }}"
                                    data-col="{{ forloop.counter0 }}"
                                    onclick="makeMove({{ forloop.parentloop.counter0 }}, {{ forloop.counter0 }})"
                                    {% if game.status != 'playing' or cell %}disabled{% endif %}>
                                    {{ cell }}
                                </button>
                            {% endfor %}
                        {% endfor %}
                    </div>
                </div>
            </div>

            <div class="text-center">
                <a href="{% url 'pybo:tictactoe_list' %}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-2"></i>Î™©Î°ùÏúºÎ°ú
                </a>
            </div>
        </div>
    </div>
</div>

<!-- ÏäπÏûê Î∞∞ÎÑà -->
<div class="overlay" id="overlay"></div>
<div class="winner-banner" id="winnerBanner" style="display: none;">
    <div class="text-center">
        <h1 id="winnerText"></h1>
        <button class="btn btn-primary mt-3" onclick="location.reload()">
            <i class="fas fa-redo me-2"></i>Îã§ÏãúÌïòÍ∏∞
        </button>
    </div>
</div>

<input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">

<script>
const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
const gameId = {{ game.id }};
const isPlayerX = {{ is_player_x|yesno:"true,false" }};
const isPlayerO = {{ is_player_o|yesno:"true,false" }};
let currentTurn = '{{ game.current_turn }}';
let gameStatus = '{{ game.status }}';

// === WebSocket Ïó∞Í≤∞ ===
let gameSocket = null;

function initWebSocket() {
    const wsScheme = window.location.protocol === 'https:' ? 'wss' : 'ws';
    const wsPath = `${wsScheme}://${window.location.host}/ws/tictactoe/${gameId}/`;

    console.log('[TicTacToe WS] Ïó∞Í≤∞ ÏãúÎèÑ:', wsPath);

    gameSocket = new WebSocket(wsPath);

    gameSocket.onopen = function(e) {
        console.log('[TicTacToe WS] ‚úÖ Ïó∞Í≤∞ ÏÑ±Í≥µ!');
    };

    gameSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        console.log('[TicTacToe WS] üì® Î©îÏãúÏßÄ:', data);

        if (data.type === 'delta_update') {
            handleDeltaUpdate(data);
        } else if (data.type === 'player_connected') {
            showNotification(`${data.username}ÎãòÏù¥ Ï†ëÏÜçÌñàÏäµÎãàÎã§`, 'info');
        }
    };

    gameSocket.onclose = function(e) {
        console.log('[TicTacToe WS] Ïó∞Í≤∞ Ï¢ÖÎ£å');
    };

    gameSocket.onerror = function(e) {
        console.error('[TicTacToe WS] Ïò§Î•ò:', e);
    };
}

// === Delta Update Ï≤òÎ¶¨ ===
function handleDeltaUpdate(data) {
    const action = data.action;
    const payload = data.data;

    if (action === 'move') {
        // Ïàò ÎëêÍ∏∞ - Ï¶âÏãú UI ÏóÖÎç∞Ïù¥Ìä∏
        const cell = document.querySelector(`[data-row="${payload.row}"][data-col="${payload.col}"]`);
        if (cell) {
            cell.textContent = payload.mark;
            cell.classList.add(payload.mark === 'X' ? 'cell-x' : 'cell-o');
            cell.disabled = true;
        }

        // ÌÑ¥ Î≥ÄÍ≤Ω
        currentTurn = payload.next_turn;
        updateTurnDisplay();
        updateBoardState();

    } else if (action === 'game_over') {
        // Í≤åÏûÑ Ï¢ÖÎ£å
        const cell = document.querySelector(`[data-row="${payload.row}"][data-col="${payload.col}"]`);
        if (cell) {
            cell.textContent = payload.mark;
            cell.classList.add(payload.mark === 'X' ? 'cell-x' : 'cell-o');
            cell.disabled = true;
        }

        // Î™®Îì† ÏÖÄ ÎπÑÌôúÏÑ±Ìôî
        document.querySelectorAll('.tictactoe-cell').forEach(c => c.disabled = true);

        if (payload.draw) {
            showWinner('Î¨¥ÏäπÎ∂Ä!', '#95a5a6');
        } else {
            const winnerMark = payload.winner;
            showWinner(`${winnerMark} ÏäπÎ¶¨!`, winnerMark === 'X' ? '#e74c3c' : '#3498db');
        }

    } else if (action === 'game_started') {
        showNotification('Í≤åÏûÑÏù¥ ÏãúÏûëÎêòÏóàÏäµÎãàÎã§!', 'success');
        setTimeout(() => location.reload(), 1000);
    }
}

function updateTurnDisplay() {
    const playerXInfo = document.getElementById('playerXInfo');
    const playerOInfo = document.getElementById('playerOInfo');

    if (currentTurn === 'X') {
        playerXInfo.classList.add('active');
        playerOInfo.classList.remove('active');
    } else {
        playerXInfo.classList.remove('active');
        playerOInfo.classList.add('active');
    }
}

function updateBoardState() {
    const myTurn = (currentTurn === 'X' && isPlayerX) || (currentTurn === 'O' && isPlayerO);

    document.querySelectorAll('.tictactoe-cell').forEach(cell => {
        if (!cell.textContent && gameStatus === 'playing') {
            cell.disabled = !myTurn;
        }
    });
}

function joinGame() {
    fetch(`/pybo/tictactoe/${gameId}/join/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken,
            'Content-Type': 'application/json'
        }
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            showNotification(data.message, 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showNotification(data.message, 'error');
        }
    });
}

function makeMove(row, col) {
    // ÎÇ¥ ÌÑ¥Ïù∏ÏßÄ ÌôïÏù∏
    const myTurn = (currentTurn === 'X' && isPlayerX) || (currentTurn === 'O' && isPlayerO);
    if (!myTurn) {
        showNotification('ÎãπÏã†Ïùò ÌÑ¥Ïù¥ ÏïÑÎãôÎãàÎã§!', 'warning');
        return;
    }

    fetch(`/pybo/tictactoe/${gameId}/move/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': csrfToken
        },
        body: new URLSearchParams({ row, col })
    })
    .then(r => r.json())
    .then(data => {
        if (!data.success) {
            showNotification(data.message, 'error');
        }
        // ÏÑ±Í≥µ Ïãú WebSocketÏù¥ UIÎ•º ÏóÖÎç∞Ïù¥Ìä∏Ìï®
    });
}

function showWinner(text, color) {
    const banner = document.getElementById('winnerBanner');
    const overlay = document.getElementById('overlay');
    const winnerText = document.getElementById('winnerText');

    winnerText.textContent = text;
    winnerText.style.color = color;
    banner.style.display = 'block';
    overlay.classList.add('show');
}

function showNotification(message, type) {
    // Í∞ÑÎã®Ìïú ÏïåÎ¶º (Í∏∞Ï°¥ Ìï®Ïàò ÌôúÏö©)
    alert(message);
}

// Ï¥àÍ∏∞Ìôî
if (gameStatus === 'playing') {
    initWebSocket();
    updateBoardState();
}
</script>
{% endblock %}
