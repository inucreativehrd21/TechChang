{% extends 'base.html' %}
{% load common_tags %}

{% block title %}방명록 - 포스트잇{% endblock %}

{% block extra_css %}
<style>
body {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
}

.guestbook-container {
    position: relative;
    min-height: 80vh;
    padding: 40px 20px;
}

.postit {
    position: absolute;
    width: 200px;
    min-height: 200px;
    padding: 20px;
    background: #fff475;
    box-shadow: 5px 5px 15px rgba(0,0,0,0.3);
    font-family: 'Comic Sans MS', cursive, sans-serif;
    cursor: pointer;
    transition: all 0.3s ease;
    word-wrap: break-word;
}

.postit:hover {
    transform: scale(1.05) !important;
    box-shadow: 8px 8px 20px rgba(0,0,0,0.4);
    z-index: 1000 !important;
}

.postit::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 30px;
    background: linear-gradient(rgba(0,0,0,0.1), transparent);
}

.postit-content {
    margin-top: 10px;
    font-size: 14px;
    line-height: 1.5;
    max-height: 120px;
    overflow-y: auto;
}

.postit-footer {
    margin-top: 15px;
    padding-top: 10px;
    border-top: 1px dashed rgba(0,0,0,0.2);
    font-size: 11px;
    color: #666;
}

.delete-btn {
    position: absolute;
    top: 5px;
    right: 5px;
    background: rgba(255,255,255,0.7);
    border: none;
    border-radius: 50%;
    width: 25px;
    height: 25px;
    display: none;
    cursor: pointer;
    transition: all 0.2s;
}

.postit:hover .delete-btn {
    display: block;
}

.delete-btn:hover {
    background: #e74c3c;
    color: white;
}

.add-postit-btn {
    position: fixed;
    bottom: 30px;
    right: 30px;
    width: 70px;
    height: 70px;
    border-radius: 50%;
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    border: none;
    box-shadow: 0 8px 20px rgba(0,0,0,0.3);
    font-size: 30px;
    color: white;
    cursor: pointer;
    transition: all 0.3s ease;
    z-index: 1001;
}

.add-postit-btn:hover {
    transform: scale(1.1) rotate(90deg);
}

.modal-postit {
    background: #fff475;
    border: none;
    box-shadow: 10px 10px 30px rgba(0,0,0,0.3);
}

.color-picker {
    display: flex;
    gap: 10px;
    margin: 15px 0;
}

.color-option {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    border: 3px solid transparent;
    cursor: pointer;
    transition: all 0.2s;
}

.color-option:hover {
    transform: scale(1.2);
}

.color-option.selected {
    border-color: #333;
    transform: scale(1.1);
}

.header-card {
    background: rgba(255,255,255,0.95);
    backdrop-filter: blur(10px);
    border-radius: 15px;
    box-shadow: 0 8px 30px rgba(0,0,0,0.2);
    padding: 30px;
    margin-bottom: 40px;
}
</style>
{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="header-card">
        <h1 class="text-center mb-3">
            <i class="fas fa-sticky-note me-2" style="color: #f093fb;"></i>
            방명록
        </h1>
        <p class="text-center text-muted mb-0">
            포스트잇에 메시지를 남겨주세요!
        </p>
    </div>

    <div class="guestbook-container" id="guestbookWall">
        {% for entry in entries %}
        <div class="postit"
             data-id="{{ entry.id }}"
             style="background-color: {{ entry.color }};
                    left: {{ entry.position_x }}%;
                    top: {{ entry.position_y }}%;
                    transform: rotate({{ entry.rotation }}deg);
                    z-index: {{ forloop.counter }};">
            {% if entry.author == user %}
            <button class="delete-btn" onclick="deletePostit({{ entry.id }})">
                <i class="fas fa-times"></i>
            </button>
            {% endif %}
            <div class="postit-content">{{ entry.content }}</div>
            <div class="postit-footer">
                <strong>{{ entry.author.profile.display_name|default:entry.author.username }}</strong>
                <br>
                <small>{{ entry.create_date|date:"Y-m-d H:i" }}</small>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- 추가 버튼 -->
{% if user.is_authenticated %}
<button class="add-postit-btn" onclick="showAddModal()">
    <i class="fas fa-plus"></i>
</button>
{% endif %}

<!-- 추가 모달 -->
<div class="modal fade" id="addPostitModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content modal-postit">
            <div class="modal-header border-0">
                <h5 class="modal-title">새 포스트잇</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="postitForm" onsubmit="addPostit(event)">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label class="form-label">색상 선택</label>
                        <div class="color-picker" id="colorPicker">
                            <div class="color-option selected" style="background: #fff475;" data-color="#fff475"></div>
                            <div class="color-option" style="background: #ff7eb9;" data-color="#ff7eb9"></div>
                            <div class="color-option" style="background: #7afcff;" data-color="#7afcff"></div>
                            <div class="color-option" style="background: #c7f0bd;" data-color="#c7f0bd"></div>
                            <div class="color-option" style="background: #ffc891;" data-color="#ffc891"></div>
                            <div class="color-option" style="background: #d9b3ff;" data-color="#d9b3ff"></div>
                        </div>
                        <input type="hidden" id="selectedColor" name="color" value="#fff475">
                    </div>
                    <div class="mb-3">
                        <label for="content" class="form-label">메시지</label>
                        <textarea class="form-control"
                                  id="content"
                                  name="content"
                                  rows="4"
                                  maxlength="200"
                                  placeholder="메시지를 입력하세요 (최대 200자)"
                                  required></textarea>
                        <div class="form-text"><span id="charCount">0</span> / 200</div>
                    </div>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-dark">
                            <i class="fas fa-check me-2"></i>붙이기
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
const csrfToken = '{{ csrf_token }}';
let selectedColor = '#fff475';
let modal = null;

document.addEventListener('DOMContentLoaded', function() {
    // 모달 초기화
    modal = new bootstrap.Modal(document.getElementById('addPostitModal'));

    // 색상 선택
    document.querySelectorAll('.color-option').forEach(option => {
        option.addEventListener('click', function() {
            document.querySelectorAll('.color-option').forEach(o => o.classList.remove('selected'));
            this.classList.add('selected');
            selectedColor = this.dataset.color;
            document.getElementById('selectedColor').value = selectedColor;

            // 모달 배경색 변경
            document.querySelector('.modal-postit').style.backgroundColor = selectedColor;
        });
    });

    // 글자 수 카운트
    document.getElementById('content').addEventListener('input', function() {
        document.getElementById('charCount').textContent = this.value.length;
    });
});

function showAddModal() {
    {% if not user.is_authenticated %}
    alert('로그인이 필요합니다.');
    location.href = '/common/login/';
    return;
    {% endif %}

    document.getElementById('postitForm').reset();
    document.getElementById('charCount').textContent = '0';
    document.querySelector('.modal-postit').style.backgroundColor = '#fff475';
    modal.show();
}

function addPostit(event) {
    event.preventDefault();

    const formData = new FormData(event.target);

    fetch('/pybo/guestbook/create/', {
        method: 'POST',
        body: formData
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            // 포스트잇 추가
            const wall = document.getElementById('guestbookWall');
            const entry = data.entry;

            const postit = document.createElement('div');
            postit.className = 'postit';
            postit.dataset.id = entry.id;
            postit.style.backgroundColor = entry.color;
            postit.style.left = entry.position_x + '%';
            postit.style.top = entry.position_y + '%';
            postit.style.transform = `rotate(${entry.rotation}deg)`;
            postit.style.zIndex = wall.children.length + 1;
            postit.style.animation = 'popIn 0.5s ease';

            postit.innerHTML = `
                <button class="delete-btn" onclick="deletePostit(${entry.id})">
                    <i class="fas fa-times"></i>
                </button>
                <div class="postit-content">${entry.content}</div>
                <div class="postit-footer">
                    <strong>${entry.author}</strong><br>
                    <small>${entry.create_date}</small>
                </div>
            `;

            wall.appendChild(postit);

            modal.hide();
            alert('방명록이 작성되었습니다!');
        } else {
            alert(data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('오류가 발생했습니다.');
    });
}

function deletePostit(entryId) {
    if (!confirm('이 포스트잇을 삭제하시겠습니까?')) return;

    fetch(`/pybo/guestbook/delete/${entryId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken
        }
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            document.querySelector(`[data-id="${entryId}"]`).remove();
            alert('삭제되었습니다.');
        } else {
            alert(data.message);
        }
    });
}

// 애니메이션 추가
const style = document.createElement('style');
style.textContent = `
    @keyframes popIn {
        0% { transform: scale(0) rotate(0deg); opacity: 0; }
        50% { transform: scale(1.2) rotate(${Math.random() * 10 - 5}deg); }
        100% { transform: scale(1) rotate(var(--rotation)); opacity: 1; }
    }
`;
document.head.appendChild(style);
</script>
{% endblock %}
