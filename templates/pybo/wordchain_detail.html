{% extends 'base.html' %}
{% load common_tags %}

{% block title %}{{ game.title }} - 끝말잇기 게임{% endblock %}

{% block content %}
<div class="container my-4">
  <!-- 게임 헤더 -->
  <div class="card mb-4">
    <div class="card-header {% if game.status == 'active' %}bg-success text-white{% else %}bg-secondary text-white{% endif %}">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h4 class="mb-1">
            {% if game.status == 'active' %}
              <i class="fas fa-play-circle me-2"></i>
            {% else %}
              <i class="fas fa-flag-checkered me-2"></i>
            {% endif %}
            {{ game.title }}
          </h4>
          <small>
            생성자: {{ game.creator|display_name }} · 
            {% if game.status == 'finished' %}
              {{ game.end_date|date:"Y.m.d H:i" }} 종료
            {% else %}
              {{ game.create_date|date:"Y.m.d H:i" }} 시작
            {% endif %}
          </small>
        </div>
        <div class="text-end">
          <div class="d-flex gap-2 mb-1">
            <span class="badge bg-light text-dark">단어 {{ total_entries }}개</span>
            <span class="badge bg-light text-dark">참가자 {{ participants }}명</span>
          </div>
          {% if game.status == 'active' and user == game.creator %}
            <button class="btn btn-warning btn-sm" onclick="finishGame()">
              <i class="fas fa-stop me-1"></i>게임 종료
            </button>
          {% endif %}
        </div>
      </div>
    </div>
    
    {% if game.status == 'active' %}
      <div class="card-body {% if game.status == 'active' %}bg-success bg-opacity-10{% endif %}">
        <!-- 타임 게이지 바 -->
        <div class="mb-4">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <span class="fw-bold">
              <i class="fas fa-clock me-2"></i>남은 시간
            </span>
            <span id="timerText" class="fw-bold fs-5">
              <span id="timeRemaining">{{ timeout_seconds }}</span>초
            </span>
          </div>
          <div class="progress" style="height: 30px; border-radius: 15px;">
            <div id="timerBar"
                 class="progress-bar progress-bar-striped progress-bar-animated"
                 role="progressbar"
                 style="width: 100%; transition: width 0.1s linear, background-color 0.5s;"
                 aria-valuenow="100"
                 aria-valuemin="0"
                 aria-valuemax="100">
              <span class="fw-bold" id="timerBarText">{{ timeout_seconds }}초 남음</span>
            </div>
          </div>
        </div>

        {% if game.last_word %}
          <div class="text-center">
            <h5 class="text-success mb-2">다음 단어를 입력해주세요!</h5>
            <div class="d-inline-flex align-items-center bg-white p-3 rounded-lg border border-success">
              <span class="fs-4 me-2">{{ game.last_word }}</span>
              <i class="fas fa-arrow-right text-success mx-2"></i>
              <span class="fs-4 text-primary fw-bold">{{ game.expected_first_char }}___</span>
            </div>
          </div>
        {% else %}
          <div class="text-center">
            <h5 class="text-success">첫 단어가 등록되었습니다! 이어서 단어를 입력해보세요.</h5>
          </div>
        {% endif %}
      </div>
    {% else %}
      <div class="card-body bg-secondary bg-opacity-10">
        <div class="text-center">
          <h5 class="text-secondary">게임이 종료되었습니다</h5>
          <p class="mb-0">총 {{ total_entries }}개의 단어로 {{ participants }}명이 참여했습니다!</p>
        </div>
      </div>
    {% endif %}
  </div>
  
  {% if game.status == 'active' and not user.is_authenticated %}
    <div class="alert alert-warning d-flex justify-content-between align-items-center mt-3" role="alert">
      <div>
        <strong class="me-2">로그인이 필요합니다.</strong>
        끝말잇기 게임에 참여하려면 로그인 후 이용해주세요.
      </div>
      <div>
        <a href="{% url 'common:login' %}?next={{ request.path }}" class="btn btn-warning btn-sm">
          <i class="fas fa-sign-in-alt me-1"></i>로그인
        </a>
      </div>
    </div>
  {% endif %}

  <div class="row">
    <div class="col-lg-8">
    <!-- 단어 입력 폼 (활성 게임일 때만) -->
    {% if game.status == 'active' and user.is_authenticated %}
      <div class="mb-4">
        <div class="card border-primary">
          <div class="card-header bg-primary text-white">
            <h6 class="mb-0">
              <i class="fas fa-keyboard me-2"></i>단어 입력
            </h6>
          </div>
          <div class="card-body">
            <form id="wordForm" onsubmit="addWord(event)">
              {% csrf_token %}
              <div class="input-group">
                <input type="text" class="form-control form-control-lg" id="wordInput" 
                       placeholder="{% if game.expected_first_char %}'{{ game.expected_first_char }}'로 시작하는 단어를 입력하세요{% else %}단어를 입력하세요{% endif %}" 
                       maxlength="50" autocomplete="off">
                <button class="btn btn-primary btn-lg" type="submit">
                  <i class="fas fa-paper-plane me-1"></i>입력
                </button>
              </div>
              <small class="form-text text-muted mt-1">
                한글 2글자 이상, 이전에 사용되지 않은 단어여야 합니다.
              </small>
            </form>
          </div>
        </div>
      </div>
    {% elif game.status == 'active' and not user.is_authenticated %}
      <div class="mb-4">
        <div class="card border-warning">
          <div class="card-body text-center">
            <h6 class="text-warning mb-2">
              <i class="fas fa-sign-in-alt me-2"></i>로그인이 필요합니다
            </h6>
            <p class="mb-2">끝말잇기 게임에 참여하려면 로그인해주세요.</p>
            <a href="{% url 'common:login' %}" class="btn btn-warning">
              <i class="fas fa-sign-in-alt me-1"></i>로그인
            </a>
          </div>
        </div>
      </div>
    {% endif %}

  <!-- 단어 목록 -->
  <div>
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">
            <i class="fas fa-list me-2"></i>단어 목록 ({{ total_entries }}개)
          </h5>
        </div>
        <div class="card-body p-0">
          {% if entries %}
            <div id="wordList" class="word-chain-container" style="max-height: 500px; overflow-y: auto;">
              {% for entry in entries %}
                <div class="word-entry d-flex align-items-center p-3 {% if not forloop.last %}border-bottom{% endif %}" 
                     style="transition: all 0.2s ease;">
                  <div class="word-number me-3">
                    <span class="badge bg-primary rounded-circle" style="width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;">
                      {{ forloop.counter }}
                    </span>
                  </div>
                  <div class="word-content flex-grow-1">
                    <div class="word-text fs-5 fw-bold text-primary mb-1">{{ entry.word }}</div>
                    <small class="text-muted">
                      <i class="fas fa-user me-1"></i>{{ entry.author|display_name }}
                      <i class="fas fa-clock ms-2 me-1"></i>{{ entry.create_date|date:"m.d H:i:s" }}
                    </small>
                  </div>
                  {% if forloop.last and game.status == 'active' %}
                    <div class="next-hint text-end">
                      <div class="text-success fw-bold">다음: "{{ entry.word|last }}"</div>
                      <small class="text-muted">{{ entry.word|last }}로 시작</small>
                    </div>
                  {% endif %}
                </div>
              {% endfor %}
            </div>
          {% else %}
            <div class="text-center py-5">
              <i class="fas fa-comments fa-3x text-muted mb-3"></i>
              <h6>아직 단어가 없습니다</h6>
              <p class="text-muted">첫 번째 단어를 입력해보세요!</p>
            </div>
          {% endif %}
        </div>
      </div>
  </div>
  </div>

  <!-- 우측 채팅 패널 -->
    <div class="col-lg-4 mt-3 mt-lg-0">
      <div class="card h-100">
        <div class="card-header bg-white">
          <h6 class="mb-0">
            <i class="fas fa-comments me-2"></i>채팅
          </h6>
        </div>
        <div class="card-body p-3 d-flex flex-column" style="height: 560px;">
          <div id="chatList" class="mb-3 flex-grow-1 overflow-auto" style="background: #fff; border-radius:8px; padding:12px;">
            <!-- 메시지 항목이 여기 렌더링 됩니다 -->
          </div>

          {% if user.is_authenticated and game.status == 'active' %}
            <form id="chatForm" onsubmit="sendChat(event)" class="d-flex gap-2">
              {% csrf_token %}
              <input id="chatInput" class="form-control" type="text" placeholder="메시지를 입력하세요" maxlength="250" autocomplete="off">
              <button class="btn btn-primary" type="submit">전송</button>
            </form>
          {% elif not user.is_authenticated %}
            <div class="text-center">
              <a href="{% url 'common:login' %}?next={{ request.path }}" class="btn btn-outline-primary">로그인하고 채팅하기</a>
            </div>
          {% else %}
            <div class="text-center text-muted">게임이 종료되어 채팅을 할 수 없습니다.</div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- 뒤로 가기 -->
  <div class="text-center mt-4">
    <a href="{% url 'pybo:wordchain_list' %}" class="btn btn-outline-secondary">
      <i class="fas fa-arrow-left me-1"></i>게임 목록으로
    </a>
  </div>
</div>
{% endblock %}

{% block script %}
<script>
function addWord(event) {
    event.preventDefault();
    
    const wordInput = document.getElementById('wordInput');
    const word = wordInput.value.trim();
    
    if (!word) {
        alert('단어를 입력해주세요.');
        return;
    }
    
    // CSRF 토큰 가져오기
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    // 버튼 비활성화
    const submitBtn = event.target.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>입력중...';
    submitBtn.disabled = true;
    
    // AJAX 요청
    fetch('{% url "pybo:wordchain_add_word" game.id %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': csrfToken,
        },
        body: new URLSearchParams({
            'word': word
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // 성공시 페이지 새로고침
            location.reload();
        } else {
            alert(data.message);
            // 버튼 복구
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
            wordInput.focus();
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('오류가 발생했습니다. 다시 시도해주세요.');
        // 버튼 복구
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    });
}

function finishGame() {
    if (confirm('정말로 게임을 종료하시겠습니까?')) {
        location.href = '{% url "pybo:wordchain_finish" game.id %}';
    }
}

// 단어 목록을 맨 아래로 스크롤
document.addEventListener('DOMContentLoaded', function() {
    const wordList = document.getElementById('wordList');
    if (wordList) {
        wordList.scrollTop = wordList.scrollHeight;
    }
    
    // 입력 필드에 포커스
    const wordInput = document.getElementById('wordInput');
    if (wordInput) {
        wordInput.focus();
    }
});

// 단어 항목 호버 효과
document.addEventListener('DOMContentLoaded', function() {
    const wordEntries = document.querySelectorAll('.word-entry');
    wordEntries.forEach(entry => {
        entry.addEventListener('mouseenter', function() {
            this.style.backgroundColor = '#f8f9fa';
        });
        entry.addEventListener('mouseleave', function() {
            this.style.backgroundColor = '';
        });
    });
});

// --------- 타이머 기능 ---------
{% if game.status == 'active' %}
(function() {
    const timeoutSeconds = {{ timeout_seconds }};
    const timerBar = document.getElementById('timerBar');
    const timerText = document.getElementById('timeRemaining');
    const timerBarText = document.getElementById('timerBarText');

    {% if entries %}
    // 마지막 단어 입력 시간 (서버에서 전달)
    const lastEntryTime = new Date('{{ entries.last.create_date|date:"c" }}');
    {% else %}
    // 게임 시작 시간
    const lastEntryTime = new Date('{{ game.create_date|date:"c" }}');
    {% endif %}

    function updateTimer() {
        const now = new Date();
        const elapsedSeconds = (now - lastEntryTime) / 1000;
        const remainingSeconds = Math.max(0, timeoutSeconds - elapsedSeconds);
        const percentage = (remainingSeconds / timeoutSeconds) * 100;

        // 진행률 업데이트
        timerBar.style.width = percentage + '%';
        timerBar.setAttribute('aria-valuenow', percentage);

        // 남은 시간 표시
        const displaySeconds = Math.ceil(remainingSeconds);
        timerText.textContent = displaySeconds;
        timerBarText.textContent = displaySeconds + '초 남음';

        // 색상 변경 (초록 -> 노랑 -> 빨강)
        if (percentage > 50) {
            timerBar.classList.remove('bg-warning', 'bg-danger');
            timerBar.classList.add('bg-success');
        } else if (percentage > 25) {
            timerBar.classList.remove('bg-success', 'bg-danger');
            timerBar.classList.add('bg-warning');
        } else {
            timerBar.classList.remove('bg-success', 'bg-warning');
            timerBar.classList.add('bg-danger');
        }

        // 시간 초과 시
        if (remainingSeconds <= 0) {
            timerBarText.textContent = '시간 초과!';
            clearInterval(timerInterval);

            // 3초 후 페이지 새로고침 (게임 종료 확인)
            setTimeout(function() {
                alert('타임아웃! 게임이 종료되었습니다.');
                location.reload();
            }, 1000);
        }

        // 마지막 10초 경고음 효과 (진동)
        if (remainingSeconds <= 10 && remainingSeconds > 0) {
            timerBar.style.animation = 'shake 0.5s infinite';
        }
    }

    // 100ms마다 타이머 업데이트
    const timerInterval = setInterval(updateTimer, 100);

    // 초기 실행
    updateTimer();
})();
{% endif %}
// --------- 채팅 기능 ---------
</script>

<script>
// --------- 채팅 기능 ---------
let lastChatFetch = null;
const renderedChatKeys = new Set(); // prevent duplicate rendering (author+time+msg)

function formatChatDate(isoString) {
  if (!isoString) return '';
  try {
    const d = new Date(isoString);
    if (isNaN(d.getTime())) return isoString;
    const Y = d.getFullYear();
    const M = String(d.getMonth() + 1).padStart(2, '0');
    const D = String(d.getDate()).padStart(2, '0');
    const h = String(d.getHours()).padStart(2, '0');
    const m = String(d.getMinutes()).padStart(2, '0');
    const s = String(d.getSeconds()).padStart(2, '0');
    return `${Y}-${M}-${D} ${h}:${m}:${s}`;
  } catch (e) {
    return isoString;
  }
}

function renderChatMessage(item) {
  const wrap = document.createElement('div');
  wrap.className = 'chat-message mb-2 p-2';

  const header = document.createElement('div');
  header.className = 'small text-muted mb-1';
  // use author_display when available (profile nickname), fallback to username
  const who = item.author_display || item.author || '익명';
  const pretty = formatChatDate(item.create_date);
  header.textContent = `${who} · ${pretty}`;

  const body = document.createElement('div');
  body.textContent = item.message;

  wrap.appendChild(header);
  wrap.appendChild(body);
  return wrap;
}

function fetchChats() {
  fetch('{% url "pybo:wordchain_get_chats" game.id %}' + (lastChatFetch ? '?since=' + encodeURIComponent(lastChatFetch) : ''))
    .then(r => r.json())
    .then(data => {
          if (data.success && data.messages && data.messages.length) {
            const chatList = document.getElementById('chatList');
            data.messages.forEach(m => {
              // composite key: author + create_date + message
              const who = m.author_display || m.author || '익명';
              const key = `${who}|${m.create_date}|${m.message}`;
              if (!renderedChatKeys.has(key)) {
                chatList.appendChild(renderChatMessage(m));
                renderedChatKeys.add(key);
                lastChatFetch = m.create_date; // advance since to last seen
              }
            });
            chatList.scrollTop = chatList.scrollHeight;
          }
    }).catch(e => console.error(e));
}

function sendChat(e) {
  e.preventDefault();
  const input = document.getElementById('chatInput');
  const text = input.value.trim();
  if (!text) return;
  const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
  const btn = e.target.querySelector('button[type="submit"]');
  const old = btn.innerHTML;
  btn.innerHTML = '전송중...'; btn.disabled = true;

  fetch('{% url "pybo:wordchain_add_chat" game.id %}', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/x-www-form-urlencoded',
      'X-CSRFToken': csrfToken
    },
    body: new URLSearchParams({message: text})
  }).then(r => r.json()).then(data => {
    if (data.success) {
      const chatList = document.getElementById('chatList');
      // server returns create_date in ISO format
  const who = data.author_display || data.author || '익명';
  const key = `${who}|${data.create_date}|${data.message}`;
      if (!renderedChatKeys.has(key)) {
        chatList.appendChild(renderChatMessage(data));
        renderedChatKeys.add(key);
        lastChatFetch = data.create_date;
      }
      chatList.scrollTop = chatList.scrollHeight;
      input.value = '';
    } else {
      alert(data.message || '메시지 전송 실패');
    }
  }).catch(err => {
    console.error(err);
    alert('오류가 발생했습니다.');
  }).finally(() => { btn.innerHTML = old; btn.disabled = false; });
}

// 주기적 폴링
document.addEventListener('DOMContentLoaded', function() {
  fetchChats();
  setInterval(fetchChats, 3000);
});
</script>

<style>
.word-chain-container {
    background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
}

.word-entry:hover {
    background-color: #f8f9fa !important;
}

.word-number .badge {
    font-size: 0.8rem;
}

.word-text {
    text-shadow: 0 1px 2px rgba(0,0,0,0.1);
}

.next-hint {
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
}

#wordInput:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
}

/* Chat styles */
.chat-message {
  background: #fff;
  border-radius: 6px;
  box-shadow: 0 1px 2px rgba(0,0,0,0.04);
}

#chatList {
  background: #fafafa;
}

/* Timer shake animation */
@keyframes shake {
  0%, 100% { transform: translateX(0); }
  25% { transform: translateX(-5px); }
  75% { transform: translateX(5px); }
}
</style>
{% endblock %}