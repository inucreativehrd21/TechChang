{% extends 'base.html' %}
{% load common_tags %}

{% block title %}{{ game.title }} - ëë§ì‡ê¸° ê²Œì„{% endblock %}

{% block extra_css %}
<style>
/* Optimistic UI ì• ë‹ˆë©”ì´ì…˜ */
@keyframes fadeOut {
  from { opacity: 1; transform: translateX(0); }
  to { opacity: 0; transform: translateX(-20px); }
}

.pending-word {
  border-left: 3px solid #ffc107 !important;
}

/* ê²Œì„ ì»¨í…Œì´ë„ˆ */
.game-container {
  max-width: 1400px;
  margin: 0 auto;
}

/* ì›í˜• íƒ€ì´ë¨¸ */
.circular-timer {
  position: relative;
  width: 200px;
  height: 200px;
  margin: 0 auto 30px;
}

.circular-timer svg {
  transform: rotate(-90deg);
}

.circular-timer .circle-bg {
  fill: none;
  stroke: #e9ecef;
  stroke-width: 10;
}

.circular-timer .circle-progress {
  fill: none;
  stroke: #28a745;
  stroke-width: 10;
  stroke-linecap: round;
  transition: stroke 0.3s ease;
  stroke-dasharray: 565.48;
  stroke-dashoffset: 0;
}

.timer-text {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
}

.timer-number {
  font-size: 3rem;
  font-weight: bold;
  color: #28a745;
  transition: color 0.3s ease;
}

/* ë‹¨ì–´ ì²´ì¸ ì• ë‹ˆë©”ì´ì…˜ */
.word-chain {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 20px;
  padding: 30px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border-radius: 20px;
  box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
  animation: glow 2s ease-in-out infinite alternate;
}

@keyframes glow {
  from { box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3); }
  to { box-shadow: 0 10px 50px rgba(102, 126, 234, 0.6); }
}

.word-display {
  background: white;
  padding: 20px 40px;
  border-radius: 15px;
  font-size: 2.5rem;
  font-weight: bold;
  color: #667eea;
  box-shadow: 0 5px 15px rgba(0,0,0,0.1);
  animation: pulse 1.5s ease-in-out infinite;
}

@keyframes pulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.05); }
}

.arrow-icon {
  font-size: 2rem;
  color: white;
  animation: bounce 1s ease-in-out infinite;
}

@keyframes bounce {
  0%, 100% { transform: translateX(0); }
  50% { transform: translateX(10px); }
}

/* ë‹¨ì–´ ì…ë ¥ í¼ */
.word-input-container {
  background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
  border-radius: 20px;
  padding: 30px;
  box-shadow: 0 10px 30px rgba(240, 147, 251, 0.3);
}

.word-input {
  font-size: 1.5rem;
  padding: 15px 20px;
  border: 3px solid transparent;
  border-radius: 15px;
  transition: all 0.3s ease;
  background: white;
}

.word-input:focus {
  border-color: #f5576c;
  box-shadow: 0 0 20px rgba(245, 87, 108, 0.5);
  transform: scale(1.02);
}

.submit-btn {
  padding: 15px 40px;
  font-size: 1.2rem;
  border-radius: 15px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border: none;
  color: white;
  font-weight: bold;
  transition: all 0.3s ease;
  box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
}

.submit-btn:hover {
  transform: translateY(-3px);
  box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6);
}

/* ë‹¨ì–´ ëª©ë¡ ì¹´ë“œ */
.word-item {
  background: white;
  border-radius: 15px;
  padding: 20px;
  margin-bottom: 15px;
  box-shadow: 0 3px 10px rgba(0,0,0,0.1);
  transition: all 0.3s ease;
  border-left: 5px solid transparent;
  animation: slideIn 0.5s ease-out;
}

@keyframes slideIn {
  from {
    opacity: 0;
    transform: translateX(-30px);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}

.word-item:hover {
  transform: translateX(10px);
  box-shadow: 0 5px 20px rgba(0,0,0,0.15);
  border-left-color: #667eea;
}

.word-item.latest {
  border-left-color: #f5576c;
  background: linear-gradient(90deg, #fff 0%, #fff5f7 100%);
}

.word-badge {
  display: inline-block;
  width: 40px;
  height: 40px;
  line-height: 40px;
  text-align: center;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border-radius: 50%;
  font-weight: bold;
  box-shadow: 0 3px 10px rgba(102, 126, 234, 0.3);
}

/* ê²Œì„ ì¢…ë£Œ ì˜¤ë²„ë ˆì´ */
.game-over-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.8);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 9999;
  animation: fadeIn 0.5s ease;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.game-over-content {
  background: white;
  padding: 50px;
  border-radius: 30px;
  text-align: center;
  box-shadow: 0 20px 60px rgba(0,0,0,0.3);
  animation: zoomIn 0.5s ease;
}

@keyframes zoomIn {
  from { transform: scale(0.5); opacity: 0; }
  to { transform: scale(1); opacity: 1; }
}

/* ì±„íŒ… */
.chat-container {
  background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
  border-radius: 20px;
  padding: 20px;
  height: 600px;
  display: flex;
  flex-direction: column;
  box-shadow: 0 10px 30px rgba(79, 172, 254, 0.3);
}

.chat-messages {
  flex-grow: 1;
  overflow-y: auto;
  padding: 15px;
  background: rgba(255,255,255,0.9);
  border-radius: 15px;
  margin-bottom: 15px;
}

.chat-message {
  background: white;
  padding: 12px 18px;
  border-radius: 12px;
  margin-bottom: 10px;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  animation: slideIn 0.3s ease;
}

.chat-input {
  border-radius: 15px;
  border: none;
  padding: 12px 20px;
  font-size: 1rem;
}

.chat-send-btn {
  border-radius: 15px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border: none;
  padding: 12px 25px;
  color: white;
  font-weight: bold;
}

/* ë°˜ì‘í˜• */
@media (max-width: 768px) {
  .word-display {
    font-size: 1.8rem;
    padding: 15px 25px;
  }

  .circular-timer {
    width: 150px;
    height: 150px;
  }

  .timer-number {
    font-size: 2rem;
  }
}

/* ìŠ¤í¬ë¡¤ë°” ì»¤ìŠ¤í…€ */
.chat-messages::-webkit-scrollbar,
.word-list-container::-webkit-scrollbar {
  width: 8px;
}

.chat-messages::-webkit-scrollbar-track,
.word-list-container::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 10px;
}

.chat-messages::-webkit-scrollbar-thumb,
.word-list-container::-webkit-scrollbar-thumb {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border-radius: 10px;
}
</style>
{% endblock %}

{% block content %}
<div class="container game-container my-4">
  <!-- ê²Œì„ íƒ€ì´í‹€ í—¤ë” -->
  <div class="card border-0 shadow-sm mb-4" style="border-radius: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
    <div class="card-body text-center text-white py-4">
      <h2 class="display-5 fw-bold mb-3">
        {% if game.status == 'waiting' %}
          <i class="fas fa-hourglass-half me-2"></i>
        {% elif game.status == 'active' %}
          <i class="fas fa-fire me-2"></i>
        {% else %}
          <i class="fas fa-flag-checkered me-2"></i>
        {% endif %}
        {{ game.title }}
      </h2>
      <div class="d-flex flex-wrap justify-content-center gap-3">
        <span class="badge bg-white text-primary fs-6 px-3 py-2" style="border-radius: 12px;">
          <i class="fas fa-hashtag me-1"></i>ë‹¨ì–´ {{ total_entries }}ê°œ
        </span>
        <span class="badge bg-white text-success fs-6 px-3 py-2" style="border-radius: 12px;">
          <i class="fas fa-users me-1"></i>ì°¸ê°€ì {{ participant_count }}/{{ game.max_participants }}ëª…
        </span>
        <span class="badge bg-white text-info fs-6 px-3 py-2" style="border-radius: 12px;">
          <i class="fas fa-crown me-1"></i>{{ game.creator|display_name }}
        </span>
        <span class="badge bg-white text-{% if game.status == 'waiting' %}warning{% elif game.status == 'active' %}success{% else %}secondary{% endif %} fs-6 px-3 py-2" style="border-radius: 12px;">
          <i class="fas fa-circle me-1" style="font-size: 0.6em;"></i>{{ game.get_status_display }}
        </span>
      </div>
    </div>
  </div>

  {% if game.status == 'waiting' %}
    <!-- ëŒ€ê¸°ì‹¤ UI -->
    <div class="row g-4 justify-content-center">
      <div class="col-lg-8">
        <div class="card border-0 shadow-lg" style="border-radius: 25px; overflow: hidden;">
          <div class="card-header text-white text-center py-4" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
            <h3><i class="fas fa-hourglass-half me-2"></i>ê²Œì„ ëŒ€ê¸° ì¤‘</h3>
            <p class="mb-0">ìµœì†Œ 2ëª… ì´ìƒì˜ ì°¸ê°€ìê°€ í•„ìš”í•©ë‹ˆë‹¤</p>
          </div>
          <div class="card-body p-4">
            <!-- ì°¸ê°€ì ëª©ë¡ -->
            <h5 class="mb-3"><i class="fas fa-users me-2"></i>ì°¸ê°€ì ({{ participant_count }}/{{ game.max_participants }})</h5>
            <div class="row g-3 mb-4">
              {% for participant in participants %}
              <div class="col-md-6">
                <div class="d-flex align-items-center p-3 bg-light rounded">
                  <i class="fas fa-user-circle fa-2x text-primary me-3"></i>
                  <div>
                    <strong>{{ participant|display_name }}</strong>
                    {% if participant == game.creator %}
                    <span class="badge bg-warning text-dark ms-2">ë°©ì¥</span>
                    {% endif %}
                  </div>
                </div>
              </div>
              {% endfor %}
            </div>

            <!-- ë²„íŠ¼ ì˜ì—­ -->
            <div class="d-flex gap-3 justify-content-center">
              {% if user.is_authenticated %}
                {% if user in participants.all %}
                  {% if user == game.creator %}
                    <button class="btn btn-success btn-lg" onclick="startGame()">
                      <i class="fas fa-play me-2"></i>ê²Œì„ ì‹œì‘
                    </button>
                  {% else %}
                    <div class="alert alert-info mb-0">
                      <i class="fas fa-info-circle me-2"></i>ë°©ì¥ì´ ê²Œì„ì„ ì‹œì‘í•  ë•Œê¹Œì§€ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”
                    </div>
                  {% endif %}
                {% else %}
                  {% if participant_count < game.max_participants %}
                    <button class="btn btn-primary btn-lg" onclick="joinGame()">
                      <i class="fas fa-sign-in-alt me-2"></i>ê²Œì„ ì°¸ê°€
                    </button>
                  {% else %}
                    <div class="alert alert-warning mb-0">
                      <i class="fas fa-users-slash me-2"></i>ì°¸ê°€ìê°€ ê½‰ ì°¼ìŠµë‹ˆë‹¤
                    </div>
                  {% endif %}
                {% endif %}
              {% else %}
                <a href="{% url 'common:login' %}?next={{ request.path }}" class="btn btn-primary btn-lg">
                  <i class="fas fa-sign-in-alt me-2"></i>ë¡œê·¸ì¸í•˜ê³  ì°¸ì—¬í•˜ê¸°
                </a>
              {% endif %}
            </div>

            <!-- ì²« ë‹¨ì–´ í‘œì‹œ -->
            {% if game.last_word %}
            <div class="mt-4 text-center">
              <h5 class="text-muted">ì‹œì‘ ë‹¨ì–´</h5>
              <div class="display-4 fw-bold text-primary">{{ game.last_word }}</div>
            </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>


  {% elif game.status == 'active' %}
    <div class="row g-4">
      <div class="col-lg-8">
        <!-- íƒ€ì´ë¨¸ & ë‹¨ì–´ ì²´ì¸ -->
        <div class="card border-0 shadow-lg mb-4" style="border-radius: 25px; overflow: hidden;">
          <div class="card-body p-4" style="background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);">
            <!-- ì›í˜• íƒ€ì´ë¨¸ -->
            <div class="circular-timer">
              <svg width="200" height="200">
                <circle class="circle-bg" cx="100" cy="100" r="90"></circle>
                <circle class="circle-progress" id="circleProgress" cx="100" cy="100" r="90"></circle>
              </svg>
              <div class="timer-text">
                <div class="timer-number" id="timerNumber">{{ timeout_seconds }}</div>
                <div class="small text-muted">ì´ˆ ë‚¨ìŒ</div>
              </div>
            </div>

            <!-- ë‹¨ì–´ ì²´ì¸ -->
            {% if game.last_word %}
              <div class="word-chain">
                <div class="word-display">
                  {{ game.last_word }}
                </div>
                <i class="fas fa-long-arrow-alt-right arrow-icon"></i>
                <div class="word-display" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white;">
                  {{ game.expected_first_char }}___
                </div>
              </div>
            {% else %}
              <div class="text-center">
                <h4 class="text-primary">ì²« ë‹¨ì–´ë¶€í„° ì‹œì‘í•´ë³´ì„¸ìš”!</h4>
              </div>
            {% endif %}
          </div>
        </div>


        <!-- í˜„ì¬ í„´ í‘œì‹œ -->
        {% if game.current_turn %}
        <div class="alert alert-info text-center mb-4" style="border-radius: 20px;">
          <h5 class="mb-0">
            <i class="fas fa-hand-point-right me-2"></i>
            í˜„ì¬ ì°¨ë¡€: <strong>{{ game.current_turn|display_name }}</strong>
            {% if game.current_turn == user %}
              <span class="badge bg-success ms-2">ë‚´ ì°¨ë¡€!</span>
            {% endif %}
          </h5>
        </div>
        {% endif %}

        <!-- ë‹¨ì–´ ì…ë ¥ í¼ -->
        {% if user.is_authenticated %}
          <div class="word-input-container mb-4">
            <form id="wordForm" onsubmit="addWord(event)">
              {% csrf_token %}
              <div class="d-flex gap-3">
                <input type="text"
                       class="form-control word-input flex-grow-1"
                       id="wordInput"
                       placeholder="{% if game.expected_first_char %}'{{ game.expected_first_char }}'ë¡œ ì‹œì‘í•˜ëŠ” ë‹¨ì–´ ì…ë ¥{% else %}ë‹¨ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”{% endif %}"
                       maxlength="50"
                       autocomplete="off"
                       {% if game.current_turn and game.current_turn != user %}disabled{% endif %}
                       required>
                <button class="btn submit-btn" type="submit">
                  <i class="fas fa-paper-plane me-2"></i>ì…ë ¥
                </button>
              </div>
              <small class="text-white mt-2 d-block">
                <i class="fas fa-info-circle me-1"></i>
                í•œê¸€ 2ê¸€ì ì´ìƒ, ì‚¬ì „ì— ë“±ì¬ëœ ë‹¨ì–´ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤
              </small>
            </form>
          </div>
        {% else %}
          <div class="alert alert-warning text-center">
            <h5><i class="fas fa-lock me-2"></i>ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤</h5>
            <a href="{% url 'common:login' %}?next={{ request.path }}" class="btn btn-primary mt-2">
              <i class="fas fa-sign-in-alt me-2"></i>ë¡œê·¸ì¸í•˜ê³  ì°¸ì—¬í•˜ê¸°
            </a>
          </div>
        {% endif %}

        <!-- ë‹¨ì–´ ëª©ë¡ -->
        <div class="card border-0 shadow-lg" style="border-radius: 25px; overflow: hidden;">
          <div class="card-header bg-white border-0 p-4">
            <h4 class="mb-0">
              <i class="fas fa-list-ul me-2" style="color: #667eea;"></i>
              ë‹¨ì–´ ëª©ë¡
            </h4>
          </div>
          <div class="card-body p-4 word-list-container" style="max-height: 500px; overflow-y: auto;">
            {% if entries %}
              <div id="wordList">
                {% for entry in entries reversed %}
                  <div class="word-item {% if forloop.first %}latest{% endif %}">
                    <div class="d-flex align-items-center justify-content-between">
                      <div class="d-flex align-items-center gap-3">
                        <div class="word-badge">{{ forloop.revcounter }}</div>
                        <div>
                          <div class="fs-4 fw-bold text-primary">{{ entry.word }}</div>
                          <small class="text-muted">
                            <i class="fas fa-user me-1"></i>{{ entry.author|display_name }}
                            <i class="fas fa-clock ms-2 me-1"></i>{{ entry.create_date|date:"H:i:s" }}
                          </small>
                        </div>
                      </div>
                      {% if forloop.first %}
                        <span class="badge bg-danger">ìµœì‹ </span>
                      {% endif %}
                    </div>
                  </div>
                {% endfor %}
              </div>
            {% else %}
              <div class="text-center py-5">
                <i class="fas fa-comment-slash fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">ì•„ì§ ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤</h5>
              </div>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- ìš°ì¸¡ ì±„íŒ… -->
      <div class="col-lg-4">
        <div class="chat-container">
          <h5 class="text-white mb-3">
            <i class="fas fa-comments me-2"></i>ì±„íŒ…
          </h5>
          <div class="chat-messages" id="chatList">
            <!-- ì±„íŒ… ë©”ì‹œì§€ -->
          </div>
          {% if user.is_authenticated %}
            <form id="chatForm" onsubmit="sendChat(event)" class="d-flex gap-2">
              {% csrf_token %}
              <input id="chatInput" class="form-control chat-input" type="text" placeholder="ë©”ì‹œì§€ ì…ë ¥..." maxlength="250" autocomplete="off" required>
              <button class="btn chat-send-btn" type="submit">
                <i class="fas fa-paper-plane"></i>
              </button>
            </form>
          {% endif %}
        </div>

        <!-- ê²Œì„ ì¢…ë£Œ ë²„íŠ¼ -->
        {% if user == game.creator %}
          <button class="btn btn-danger w-100 mt-3" style="border-radius: 15px; padding: 15px;" onclick="finishGame()">
            <i class="fas fa-stop-circle me-2"></i>ê²Œì„ ì¢…ë£Œ
          </button>
        {% endif %}
      </div>
    </div>
  {% else %}
    <!-- ê²Œì„ ì¢…ë£Œ í™”ë©´ -->
    <div class="text-center py-5">
      <div class="card border-0 shadow-lg mx-auto" style="max-width: 600px; border-radius: 25px;">
        <div class="card-body p-5">
          <i class="fas fa-trophy fa-4x text-warning mb-4"></i>
          <h2 class="mb-3">ê²Œì„ ì¢…ë£Œ!</h2>
          <p class="lead text-muted">
            ì´ <strong class="text-primary">{{ total_entries }}ê°œ</strong>ì˜ ë‹¨ì–´ë¡œ<br>
            <strong class="text-success">{{ participant_count }}ëª…</strong>ì´ ì°¸ì—¬í–ˆìŠµë‹ˆë‹¤!
          </p>
          <a href="{% url 'pybo:wordchain_list' %}" class="btn btn-primary btn-lg mt-3" style="border-radius: 15px;">
            <i class="fas fa-list me-2"></i>ê²Œì„ ëª©ë¡ìœ¼ë¡œ
          </a>
        </div>
      </div>
    </div>
  {% endif %}
</div>

<!-- ê²Œì„ ì˜¤ë²„ ì˜¤ë²„ë ˆì´ -->
<div class="game-over-overlay" id="gameOverOverlay">
  <div class="game-over-content">
    <i class="fas fa-hourglass-end fa-4x text-danger mb-4"></i>
    <h2 class="mb-3">íƒ€ì„ ì•„ì›ƒ!</h2>
    <p class="lead">ì œí•œ ì‹œê°„ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.</p>
    <button class="btn btn-primary btn-lg mt-3" onclick="location.reload()">
      <i class="fas fa-redo me-2"></i>ìƒˆë¡œê³ ì¹¨
    </button>
  </div>
</div>
{% endblock %}

{% block script %}
<script>
// CSRF í† í°
const csrfToken = '{{ csrf_token }}';

// ë‹¨ì–´ ì¶”ê°€
// === Optimistic UI - ì¦‰ì‹œ ë°˜ì‘í•˜ëŠ” ë‹¨ì–´ ì œì¶œ ===
let pendingWordElement = null;  // ë‚™ê´€ì  ì—…ë°ì´íŠ¸ë¡œ ì¶”ê°€í•œ ìš”ì†Œ

function addWord(event) {
    event.preventDefault();

    const wordInput = document.getElementById('wordInput');
    const word = wordInput.value.trim();

    if (!word) {
        showNotification('ë‹¨ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning');
        return;
    }

    const submitBtn = event.target.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>ì „ì†¡ì¤‘...';
    submitBtn.disabled = true;
    wordInput.disabled = true;

    // === OPTIMISTIC UPDATE: ì„œë²„ ì‘ë‹µ ê¸°ë‹¤ë¦¬ì§€ ì•Šê³  ì¦‰ì‹œ UI ì—…ë°ì´íŠ¸ ===
    const now = new Date();
    const optimisticEntry = {
        word: word,
        author: '{{ user.username }}',
        author_display: '{% if user.profile %}{{ user.profile.display_name }}{% else %}{{ user.username }}{% endif %}',
        create_date: now.toISOString(),
        isPending: true  // í™•ì¸ ëŒ€ê¸°ì¤‘ í‘œì‹œ
    };
    
    console.log('[Optimistic] ì¦‰ì‹œ UI ì—…ë°ì´íŠ¸:', word);
    
    // ë‹¨ì–´ ëª©ë¡ì— ì¦‰ì‹œ ì¶”ê°€ (íšŒìƒ‰ìœ¼ë¡œ í‘œì‹œ)
    const wordList = document.getElementById('wordList');
    const newWordItem = document.createElement('div');
    newWordItem.className = 'word-item pending-word';
    newWordItem.style.opacity = '0.6';
    newWordItem.style.animation = 'slideInRight 0.3s ease';
    newWordItem.dataset.wordKey = word + '|' + now.toISOString();
    
    newWordItem.innerHTML = `
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <span class="word-text">${word}</span>
                <small class="text-muted ms-2">by ${optimisticEntry.author_display}</small>
                <span class="badge bg-secondary ms-2">í™•ì¸ì¤‘...</span>
            </div>
            <small class="text-muted">ë°©ê¸ˆ</small>
        </div>
    `;
    wordList.insertBefore(newWordItem, wordList.firstChild);
    pendingWordElement = newWordItem;
    
    // ì…ë ¥ì°½ ì´ˆê¸°í™”
    wordInput.value = '';
    
    // ë‹¤ìŒ ê¸€ì ë¯¸ë¦¬ í‘œì‹œ
    updateExpectedChar(word[word.length - 1]);

    // === ì„œë²„ì— ì „ì†¡ (ë°±ê·¸ë¼ìš´ë“œ) ===
    fetch('{% url "pybo:wordchain_add_word" game.id %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': csrfToken,
        },
        body: new URLSearchParams({ 'word': word })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // === ì„œë²„ í™•ì¸ ì„±ê³µ: pending í‘œì‹œ ì œê±° ===
            console.log('[Optimistic] âœ… ì„œë²„ í™•ì¸ ì™„ë£Œ');
            if (pendingWordElement) {
                pendingWordElement.style.opacity = '1';
                pendingWordElement.classList.remove('pending-word');
                const badge = pendingWordElement.querySelector('.badge');
                if (badge) badge.remove();
                pendingWordElement = null;
            }
            
            showNotification('âœ… ë‹¨ì–´ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
            
            // WebSocketì´ í„´ì„ ì—…ë°ì´íŠ¸í•  ê²ƒì„ (Delta Update)
            // í˜ì´ì§€ reload í•˜ì§€ ì•ŠìŒ!
        } else {
            // === ì„œë²„ í™•ì¸ ì‹¤íŒ¨: ë¡¤ë°± ===
            console.log('[Optimistic] âŒ ì„œë²„ ê±°ë¶€, ë¡¤ë°±:', data.message);
            if (pendingWordElement) {
                pendingWordElement.style.animation = 'fadeOut 0.3s ease';
                setTimeout(() => {
                    if (pendingWordElement) pendingWordElement.remove();
                    pendingWordElement = null;
                }, 300);
            }
            
            // ë‹¨ì–´ ë‹¤ì‹œ ì…ë ¥ì°½ì— í‘œì‹œ
            wordInput.value = word;
            
            showNotification('âŒ ' + (data.message || 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'), 'error');
            
            // ê²Œì„ ì¢…ë£Œ ë©”ì‹œì§€ ì²˜ë¦¬
            if (data.game_ended || data.timeout) {
                setTimeout(() => location.reload(), 1500);
            }
        }
        
        // UI ì›ìƒë³µêµ¬
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
        wordInput.disabled = false;
        wordInput.focus();
    })
    .catch(error => {
        console.error('[Optimistic] ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜:', error);
        
        // === ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ë¡¤ë°± ===
        if (pendingWordElement) {
            pendingWordElement.remove();
            pendingWordElement = null;
        }
        wordInput.value = word;
        
        showNotification('âš ï¸ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
        wordInput.disabled = false;
    });
}

function finishGame() {
    if (confirm('ì •ë§ë¡œ ê²Œì„ì„ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        location.href = '{% url "pybo:wordchain_finish" game.id %}';
    }
}

function joinGame() {
    fetch('{% url "pybo:wordchain_join" game.id %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(data.message, 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showNotification(data.message, 'error');
        }
    })
    .catch(error => {
        showNotification('ì°¸ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
        console.error('Error:', error);
    });
}

function startGame() {
    fetch('{% url "pybo:wordchain_start" game.id %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(data.message, 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showNotification(data.message, 'error');
        }
    })
    .catch(error => {
        showNotification('ê²Œì„ ì‹œì‘ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
        console.error('Error:', error);
    });
}


// ì•Œë¦¼ í‘œì‹œ
function showNotification(message, type) {
    const colors = {
        success: '#28a745',
        warning: '#ffc107',
        error: '#dc3545'
    };

    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${colors[type]};
        color: white;
        padding: 20px 30px;
        border-radius: 15px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        z-index: 10000;
        animation: slideIn 0.5s ease;
    `;
    notification.textContent = message;
    document.body.appendChild(notification);

    setTimeout(() => {
        notification.style.animation = 'fadeOut 0.5s ease';
        setTimeout(() => notification.remove(), 500);
    }, 3000);
}

{% if game.status == 'active' %}
// íƒ€ì´ë¨¸ ê¸°ëŠ¥
(function() {
    const timeoutSeconds = {{ timeout_seconds }};
    const circleProgress = document.getElementById('circleProgress');
    const timerNumber = document.getElementById('timerNumber');
    const radius = 90;
    const circumference = 2 * Math.PI * radius;

    // ê²Œì„ ì‹œì‘ ì´í›„ì˜ ì—”íŠ¸ë¦¬ë§Œ ì²´í¬
    {% if game.start_date %}
        // ê²Œì„ ì‹œì‘ ì´í›„ì˜ ë§ˆì§€ë§‰ ì—”íŠ¸ë¦¬ ì‹œê°„ ì‚¬ìš©
        const gameStartTime = new Date('{{ game.start_date|date:"c" }}');
        let lastEntryTime = gameStartTime;
        
        {% if entries %}
            // ê²Œì„ ì‹œì‘ ì´í›„ì˜ ì—”íŠ¸ë¦¬ ì¤‘ ë§ˆì§€ë§‰ ê²ƒ
            const allEntries = [
                {% for entry in entries %}
                    {% if entry.create_date >= game.start_date %}
                        new Date('{{ entry.create_date|date:"c" }}'),
                    {% endif %}
                {% endfor %}
            ].filter(Boolean);
            
            if (allEntries.length > 0) {
                lastEntryTime = allEntries[allEntries.length - 1];
            }
        {% endif %}
    {% else %}
        // ê²Œì„ ì‹œì‘ ì „ì´ë©´ íƒ€ì´ë¨¸ ì—†ìŒ
        const lastEntryTime = new Date();
    {% endif %}

    function updateTimer() {
        const now = new Date();
        const elapsedSeconds = (now - lastEntryTime) / 1000;
        const remainingSeconds = Math.max(0, timeoutSeconds - elapsedSeconds);
        const percentage = (remainingSeconds / timeoutSeconds) * 100;

        // ì›í˜• í”„ë¡œê·¸ë ˆìŠ¤ ë°” ì—…ë°ì´íŠ¸
        const offset = circumference - (percentage / 100) * circumference;
        circleProgress.style.strokeDashoffset = offset;

        // ìˆ«ì ì—…ë°ì´íŠ¸
        const displaySeconds = Math.ceil(remainingSeconds);
        timerNumber.textContent = displaySeconds;

        // ìƒ‰ìƒ ë³€ê²½
        if (percentage > 50) {
            circleProgress.style.stroke = '#28a745';
            timerNumber.style.color = '#28a745';
        } else if (percentage > 25) {
            circleProgress.style.stroke = '#ffc107';
            timerNumber.style.color = '#ffc107';
        } else {
            circleProgress.style.stroke = '#dc3545';
            timerNumber.style.color = '#dc3545';
        }

        // íƒ€ì„ì•„ì›ƒ
        if (remainingSeconds <= 0) {
            clearInterval(timerInterval);
            document.getElementById('gameOverOverlay').style.display = 'flex';
            setTimeout(() => {
                showNotification('íƒ€ì„ì•„ì›ƒ! ê²Œì„ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.', 'error');
                setTimeout(() => location.reload(), 2000);
            }, 500);
        }

        // ë§ˆì§€ë§‰ 10ì´ˆ ì§„ë™ íš¨ê³¼
        if (remainingSeconds <= 10 && remainingSeconds > 0) {
            timerNumber.style.animation = 'shake 0.5s infinite';
        }
    }

    // ì´ˆê¸° ì„¤ì •
    circleProgress.style.strokeDasharray = circumference;
    const timerInterval = setInterval(updateTimer, 100);
    updateTimer();
})();

// Shake ì• ë‹ˆë©”ì´ì…˜ ì¶”ê°€
const style = document.createElement('style');
style.textContent = `
    @keyframes shake {
        0%, 100% { transform: translate(-50%, -50%) rotate(0deg); }
        25% { transform: translate(-50%, -50%) rotate(-5deg); }
        75% { transform: translate(-50%, -50%) rotate(5deg); }
    }
`;
document.head.appendChild(style);
{% endif %}

// ì±„íŒ… ê¸°ëŠ¥
let lastChatFetch = null;
const renderedChatKeys = new Set();

function formatChatDate(isoString) {
  if (!isoString) return '';
  try {
    const d = new Date(isoString);
    const h = String(d.getHours()).padStart(2, '0');
    const m = String(d.getMinutes()).padStart(2, '0');
    return `${h}:${m}`;
  } catch (e) {
    return isoString;
  }
}

function renderChatMessage(item) {
  const wrap = document.createElement('div');
  wrap.className = 'chat-message';

  const who = item.author_display || item.author || 'ìµëª…';
  const pretty = formatChatDate(item.create_date);

  wrap.innerHTML = `
    <div class="d-flex justify-content-between align-items-start mb-1">
      <strong class="text-primary">${who}</strong>
      <small class="text-muted">${pretty}</small>
    </div>
    <div>${item.message}</div>
  `;

  return wrap;
}

function fetchChats() {
  fetch('{% url "pybo:wordchain_get_chats" game.id %}' + (lastChatFetch ? '?since=' + encodeURIComponent(lastChatFetch) : ''))
    .then(r => r.json())
    .then(data => {
      if (data.success && data.messages && data.messages.length) {
        const chatList = document.getElementById('chatList');
        data.messages.forEach(m => {
          const who = m.author_display || m.author || 'ìµëª…';
          const key = `${who}|${m.create_date}|${m.message}`;
          if (!renderedChatKeys.has(key)) {
            chatList.appendChild(renderChatMessage(m));
            renderedChatKeys.add(key);
            lastChatFetch = m.create_date;
          }
        });
        chatList.scrollTop = chatList.scrollHeight;
      }
    }).catch(e => console.error(e));
}

function sendChat(e) {
  e.preventDefault();
  const input = document.getElementById('chatInput');
  const text = input.value.trim();
  if (!text) return;

  const btn = e.target.querySelector('button[type="submit"]');
  const old = btn.innerHTML;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
  btn.disabled = true;

  fetch('{% url "pybo:wordchain_add_chat" game.id %}', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/x-www-form-urlencoded',
      'X-CSRFToken': csrfToken
    },
    body: new URLSearchParams({message: text})
  }).then(r => r.json()).then(data => {
    if (data.success) {
      const chatList = document.getElementById('chatList');
      const who = data.author_display || data.author || 'ìµëª…';
      const key = `${who}|${data.create_date}|${data.message}`;
      if (!renderedChatKeys.has(key)) {
        chatList.appendChild(renderChatMessage(data));
        renderedChatKeys.add(key);
        lastChatFetch = data.create_date;
      }
      chatList.scrollTop = chatList.scrollHeight;
      input.value = '';
    } else {
      showNotification(data.message || 'ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨', 'error');
    }
  }).catch(err => {
    console.error(err);
    showNotification('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
  }).finally(() => {
    btn.innerHTML = old;
    btn.disabled = false;
  });
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ
document.addEventListener('DOMContentLoaded', function() {
  fetchChats();
  setInterval(fetchChats, 3000);

  // ë‹¨ì–´ ì…ë ¥ í¬ì»¤ìŠ¤
  const wordInput = document.getElementById('wordInput');
  if (wordInput) {
    wordInput.focus();
  }
});



// === WebSocket ì‹¤ì‹œê°„ í†µì‹  (ìë™ ì¬ì—°ê²° ì§€ì›) ===
let gameSocket = null;
let useWebSocket = true;  // WebSocket ì‚¬ìš© ì—¬ë¶€
let reconnectAttempts = 0;
let maxReconnectAttempts = 5;
let reconnectDelay = 1000;  // 1ì´ˆ
let isReconnecting = false;

function initWebSocket() {
    if (!useWebSocket) return;
    
    const wsScheme = window.location.protocol === 'https:' ? 'wss' : 'ws';
    const wsPath = `${wsScheme}://${window.location.host}/ws/wordchain/{{ game.id }}/`;
    
    console.log('[WebSocket] ì—°ê²° ì‹œë„:', wsPath, `(ì‹œë„ ${reconnectAttempts + 1}/${maxReconnectAttempts})`);
    
    try {
        gameSocket = new WebSocket(wsPath);
        
        gameSocket.onopen = function(e) {
            console.log('[WebSocket] âœ… ì—°ê²° ì„±ê³µ!');
            reconnectAttempts = 0;  // ì¬ì—°ê²° ì¹´ìš´í„° ì´ˆê¸°í™”
            isReconnecting = false;
            
            // í´ë§ ì¤‘ì§€ (WebSocketì´ í™œì„±í™”ë˜ë©´ í´ë§ì€ ë°±ì—…ìš©ìœ¼ë¡œë§Œ)
            if (pollingInterval) {
                clearInterval(pollingInterval);
                pollingInterval = setInterval(fetchGameState, 10000); // ë°±ì—…ìš© 10ì´ˆ í´ë§
            }
            
            showNotification('ì‹¤ì‹œê°„ ì—°ê²° ì„±ê³µ!', 'success');
        };
        
        gameSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            console.log('[WebSocket] ğŸ“¨ ë©”ì‹œì§€:', data.type);
            
            if (data.type === 'initial_state') {
                // ì´ˆê¸° ê²Œì„ ìƒíƒœ (ì „ì²´)
                handleGameState(data.data);
            } else if (data.type === 'delta_update') {
                // Delta Update - ë³€ê²½ì‚¬í•­ë§Œ ì²˜ë¦¬ (DB ì¿¼ë¦¬ ì—†ìŒ!)
                console.log('[WebSocket] âš¡ Delta Update:', data.action);
                handleDeltaUpdate(data);
            } else if (data.type === 'player_connected') {
                console.log('[WebSocket] ğŸ‘‹ í”Œë ˆì´ì–´ ì ‘ì†:', data.username);
                showNotification(`${data.username}ë‹˜ì´ ì ‘ì†í–ˆìŠµë‹ˆë‹¤`, 'info');
            } else if (data.type === 'player_disconnected') {
                console.log('[WebSocket] ğŸ‘‹ í”Œë ˆì´ì–´ í‡´ì¥:', data.username);
                showNotification(`${data.username}ë‹˜ì´ ë‚˜ê°”ìŠµë‹ˆë‹¤`, 'warning');
            } else if (data.type === 'heartbeat_ack') {
                // Heartbeat ì‘ë‹µ
            }
        };
        
        gameSocket.onclose = function(e) {
            console.log('[WebSocket] âŒ ì—°ê²° ì¢…ë£Œ. Code:', e.code, 'Reason:', e.reason);
            gameSocket = null;
            
            // ìë™ ì¬ì—°ê²° ì‹œë„
            if (reconnectAttempts < maxReconnectAttempts && !isReconnecting) {
                isReconnecting = true;
                reconnectAttempts++;
                const delay = reconnectDelay * reconnectAttempts;
                console.log(`[WebSocket] ğŸ”„ ${delay}ms í›„ ì¬ì—°ê²° ì‹œë„...`);
                
                setTimeout(() => {
                    isReconnecting = false;
                    initWebSocket();
                }, delay);
            } else {
                console.log('[WebSocket] âš ï¸ í´ë§ ëª¨ë“œë¡œ ì™„ì „ ì „í™˜.');
                useWebSocket = false;
                // í´ë§ ì¬ê°œ (ë” ë¹ ë¥¸ ê°„ê²©)
                if (pollingInterval) {
                    clearInterval(pollingInterval);
                }
                startPolling();
            }
        };
        
        gameSocket.onerror = function(e) {
            console.error('[WebSocket] â›” ì˜¤ë¥˜ ë°œìƒ:', e);
        };
        
    } catch (error) {
        console.error('[WebSocket] ğŸ’¥ ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
        useWebSocket = false;
    }
}


// === Delta Update ì²˜ë¦¬ (ë³€ê²½ì‚¬í•­ë§Œ ì ìš©) ===
function handleDeltaUpdate(data) {
    const action = data.action;
    const payload = data.data;
    
    if (action === 'word_added') {
        // ìƒˆ ë‹¨ì–´ ì¶”ê°€ (DB ì¿¼ë¦¬ ì—†ì´ ì¦‰ì‹œ UI ì—…ë°ì´íŠ¸)
        const entry = {
            word: payload.word,
            author: payload.author,
            author_display: payload.author_display,
            create_date: payload.create_date
        };
        
        // ë‹¨ì–´ ëª©ë¡ì— ì¶”ê°€
        addWordToList(entry);
        
        // í„´ ì—…ë°ì´íŠ¸
        if (payload.current_turn_id) {
            const turnInfo = {
                id: payload.current_turn_id,
                username: payload.current_turn_username,
                display_name: payload.current_turn_display
            };
            lastCurrentTurnId = payload.current_turn_id;
            updateTurnDisplay(turnInfo);
        }
        
        console.log('[Delta] ë‹¨ì–´ ì¶”ê°€ ì™„ë£Œ (ì„œë²„ ì¿¼ë¦¬ ì—†ìŒ)');
    } else if (action === 'player_joined') {
        // ì°¸ê°€ì ë³€ê²½ - ë¶€ë¶„ ì—…ë°ì´íŠ¸ë§Œ
        console.log('[Delta] í”Œë ˆì´ì–´ ì°¸ê°€:', payload.username);
        // í•„ìš”ì‹œ ì°¸ê°€ì ìˆ˜ë§Œ ì—…ë°ì´íŠ¸
    } else if (action === 'game_started') {
        console.log('[Delta] ê²Œì„ ì‹œì‘!');
        location.reload(); // ê²Œì„ ì‹œì‘ì€ ì „ì²´ ìƒˆë¡œê³ ì¹¨
    }
}

function handleGameState(gameState) {
    if (!gameState || !gameState.game) return;
    
    const gameData = gameState.game;
    
    // í„´ ì—…ë°ì´íŠ¸
    if (gameData.current_turn && lastCurrentTurnId !== gameData.current_turn.id) {
        lastCurrentTurnId = gameData.current_turn.id;
        console.log('[WebSocket] í„´ ë³€ê²½:', gameData.current_turn.display_name);
        updateTurnDisplay(gameData.current_turn);
    }
    
    // ìƒˆ ë‹¨ì–´ ì¶”ê°€
    if (gameState.last_entry) {
        const entryKey = gameState.last_entry.word + '|' + gameState.last_entry.create_date;
        if (lastWordKey !== entryKey) {
            if (lastWordKey !== '') {
                addWordToList(gameState.last_entry);
            }
            lastWordKey = entryKey;
        }
    }
}

// ê²Œì„ ìƒíƒœ polling - ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ (500ms)
let lastGameStatus = '{{ game.status }}';
let lastParticipantCount = {{ participant_count }};
let lastCurrentTurnId = {{ game.current_turn.id|default:"null" }};
let lastWordKey = '';
let isMyTurn = false;
let pollingInterval = null;

function updateTurnDisplay(currentTurn) {
    const turnAlert = document.querySelector('.alert-info h5');
    if (!turnAlert) return;

    isMyTurn = currentTurn.id === {{ user.id|default:"0" }};
    const badge = isMyTurn ? '<span class="badge bg-success ms-2 animate__animated animate__pulse animate__infinite">ë‚´ ì°¨ë¡€!</span>' : '';
    turnAlert.innerHTML = `
        <i class="fas fa-hand-point-right me-2"></i>
        í˜„ì¬ ì°¨ë¡€: <strong>${currentTurn.display_name}</strong>
        ${badge}
    `;

    // ì…ë ¥ì°½ ì œì–´
    const wordInput = document.getElementById('wordInput');
    if (wordInput) {
        wordInput.disabled = !isMyTurn;
        if (isMyTurn) {
            wordInput.focus();
        }
    }
}

function addWordToList(entry) {
    const wordList = document.getElementById('wordList');
    if (!wordList) return;

    const newWordItem = document.createElement('div');
    newWordItem.className = 'word-item';
    newWordItem.style.animation = 'slideInRight 0.5s ease';
    newWordItem.dataset.wordKey = entry.word + '|' + entry.create_date;

    const now = new Date();
    const entryDate = new Date(entry.create_date);
    const secondsAgo = Math.floor((now - entryDate) / 1000);
    const timeText = secondsAgo < 5 ? 'ë°©ê¸ˆ' : secondsAgo < 60 ? `${secondsAgo}ì´ˆ ì „` : `${Math.floor(secondsAgo / 60)}ë¶„ ì „`;

    newWordItem.innerHTML = `
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <span class="word-text">${entry.word}</span>
                <small class="text-muted ms-2">by ${entry.author_display}</small>
            </div>
            <small class="text-muted">${timeText}</small>
        </div>
    `;
    wordList.insertBefore(newWordItem, wordList.firstChild);

    // ë‹¤ìŒ ê¸€ì í‘œì‹œ ì—…ë°ì´íŠ¸
    const lastChar = entry.word[entry.word.length - 1];
    updateExpectedChar(lastChar);

    console.log('[ì‹¤ì‹œê°„] ìƒˆ ë‹¨ì–´ ì¶”ê°€:', entry.word);
}

function updateExpectedChar(char) {
    // ë‹¨ì–´ ì²´ì¸ í‘œì‹œ ì—…ë°ì´íŠ¸
    const expectedDisplays = document.querySelectorAll('.word-display');
    if (expectedDisplays.length > 1) {
        expectedDisplays[1].textContent = char + '___';
    }

    // ì…ë ¥ì°½ placeholder ì—…ë°ì´íŠ¸
    const wordInput = document.getElementById('wordInput');
    if (wordInput) {
        wordInput.placeholder = `'${char}'ë¡œ ì‹œì‘í•˜ëŠ” ë‹¨ì–´ ì…ë ¥`;
    }
}

function fetchGameState() {
    fetch('{% url "pybo:wordchain_get_state" game.id %}')
        .then(r => r.json())
        .then(data => {
            if (!data.success) return;

            const gameData = data.game;

            // === ìƒíƒœ ë³€ê²½ ê°ì§€ ===

            // waiting -> active
            if (lastGameStatus === 'waiting' && gameData.status === 'active') {
                console.log('[ì‹¤ì‹œê°„] ê²Œì„ ì‹œì‘!');
                showNotification('ê²Œì„ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                setTimeout(() => location.reload(), 800);
                return;
            }

            // active -> finished
            if (lastGameStatus === 'active' && gameData.status === 'finished') {
                console.log('[ì‹¤ì‹œê°„] ê²Œì„ ì¢…ë£Œ!');
                showNotification('ê²Œì„ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!', 'warning');
                setTimeout(() => location.reload(), 800);
                return;
            }

            // === ëŒ€ê¸°ì‹¤ ì—…ë°ì´íŠ¸ ===
            if (gameData.status === 'waiting' && lastParticipantCount !== gameData.participant_count) {
                console.log('[ì‹¤ì‹œê°„] ì°¸ê°€ì ë³€ê²½:', lastParticipantCount, '->', gameData.participant_count);
                lastParticipantCount = gameData.participant_count;
                location.reload();
            }

            // === í™œì„± ê²Œì„ ì—…ë°ì´íŠ¸ ===
            if (gameData.status === 'active') {

                // í„´ ë³€ê²½ ê°ì§€
                if (gameData.current_turn && lastCurrentTurnId !== gameData.current_turn.id) {
                    const wasMyTurn = isMyTurn;
                    lastCurrentTurnId = gameData.current_turn.id;
                    console.log('[ì‹¤ì‹œê°„] í„´ ë³€ê²½:', gameData.current_turn.display_name);
                    updateTurnDisplay(gameData.current_turn);

                    // ë‚´ ì°¨ë¡€ê°€ ë˜ì—ˆì„ ë•Œë§Œ ì•Œë¦¼
                    if (!wasMyTurn && isMyTurn) {
                        showNotification('ë‹¹ì‹ ì˜ ì°¨ë¡€ì…ë‹ˆë‹¤!', 'success');
                    }
                }

                // ìƒˆ ë‹¨ì–´ ì¶”ê°€ ê°ì§€
                if (data.last_entry) {
                    const entryKey = data.last_entry.word + '|' + data.last_entry.create_date;

                    if (lastWordKey !== entryKey) {
                        // í˜ì´ì§€ ë¡œë“œ ì§í›„ê°€ ì•„ë‹ ë•Œë§Œ ì¶”ê°€
                        if (lastWordKey !== '') {
                            addWordToList(data.last_entry);
                        }
                        lastWordKey = entryKey;
                    }
                }
            }

            lastGameStatus = gameData.status;
        })
        .catch(e => console.error('[ì‹¤ì‹œê°„] State fetch error:', e));
}

// Polling ì‹œì‘
{% if game.status != 'finished' %}
function startPolling() {
    // ê²Œì„ ìƒíƒœì— ë”°ë¼ ë‹¤ë¥¸ ê°„ê²©
    const interval = '{{ game.status }}' === 'active' ? 5000 : 10000; // WebSocketì´ ë©”ì¸ì´ë¯€ë¡œ í´ë§ì€ ë°±ì—…ìš©ë§Œ // active: 0.05ì´ˆ, waiting: 0.5ì´ˆ

    console.log(`[ì‹¤ì‹œê°„] Polling ì‹œì‘ (ê°„ê²©: ${interval}ms)`);

    if (pollingInterval) {
        clearInterval(pollingInterval);
    }

    // ì²« ì‹¤í–‰ ì‹œ lastWordKey ì´ˆê¸°í™”
    {% if entries and game.start_date %}
    {% for entry in entries %}
    {% if entry.create_date >= game.start_date %}
    lastWordKey = '{{ entry.word }}|{{ entry.create_date|date:"c" }}';
    {% endif %}
    {% endfor %}
    {% endif %}

    pollingInterval = setInterval(fetchGameState, interval);

    // 1ì´ˆ í›„ ì²« ì‹¤í–‰ (ì´ˆê¸°í™” í›„)
    setTimeout(fetchGameState, 1000);
}

// WebSocket ë˜ëŠ” í´ë§ ì‹œì‘
if ('{{ game.status }}' !== 'finished') {
    initWebSocket();  // WebSocket ì‹œë„
    startPolling();   // í´ë§ë„ ì‹œì‘ (ë°±ì—…ìš©)
}
{% endif %}

</script>
{% endblock %}
