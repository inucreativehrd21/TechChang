{% extends 'base.html' %}

{% block title %}IP 차단 관리 - 테크창{% endblock %}

{% block content %}
<div class="container my-4">
  <!-- 페이지 헤더 -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2>
      <i class="fas fa-ban me-2 text-danger"></i>IP 차단 관리
    </h2>
    <a href="{% url 'common:admin_dashboard' %}" class="btn btn-secondary">
      <i class="fas fa-arrow-left me-2"></i>대시보드로
    </a>
  </div>

  <!-- IP 차단 추가 폼 -->
  <div class="card mb-4">
    <div class="card-header bg-white">
      <h5 class="mb-0">
        <i class="fas fa-plus-circle me-2"></i>IP 차단 추가
      </h5>
    </div>
    <div class="card-body">
      <form method="post" action="{% url 'common:admin_block_ip' %}" class="row g-3">
        {% csrf_token %}
        <div class="col-md-4">
          <label for="ip_address" class="form-label">IP 주소</label>
          <input type="text" class="form-control" id="ip_address" name="ip_address"
                 placeholder="예: 192.168.1.1" required>
        </div>
        <div class="col-md-6">
          <label for="reason" class="form-label">차단 사유</label>
          <input type="text" class="form-control" id="reason" name="reason"
                 placeholder="차단 사유를 입력하세요">
        </div>
        <div class="col-md-2">
          <label class="form-label d-block">&nbsp;</label>
          <button type="submit" class="btn btn-danger w-100">
            <i class="fas fa-ban me-2"></i>차단
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- 필터 및 검색 -->
  <div class="card mb-4">
    <div class="card-body">
      <form method="get" class="row g-3">
        <div class="col-md-3">
          <label for="status" class="form-label">상태</label>
          <select class="form-select" id="status" name="status" onchange="this.form.submit()">
            <option value="active" {% if status_filter == 'active' %}selected{% endif %}>차단 중</option>
            <option value="inactive" {% if status_filter == 'inactive' %}selected{% endif %}>차단 해제됨</option>
            <option value="all" {% if status_filter == 'all' %}selected{% endif %}>전체</option>
          </select>
        </div>
        <div class="col-md-7">
          <label for="search" class="form-label">검색</label>
          <input type="text" class="form-control" id="search" name="search"
                 placeholder="IP 주소 또는 차단 사유 검색" value="{{ search_query }}">
        </div>
        <div class="col-md-2">
          <label class="form-label d-block">&nbsp;</label>
          <button type="submit" class="btn btn-primary w-100">
            <i class="fas fa-search me-2"></i>검색
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- 차단된 IP 목록 -->
  <div class="card">
    <div class="card-header bg-white">
      <h5 class="mb-0">
        <i class="fas fa-list me-2"></i>차단된 IP 목록
      </h5>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-hover">
          <thead>
            <tr>
              <th>IP 주소</th>
              <th>차단 사유</th>
              <th>차단자</th>
              <th>차단 일시</th>
              <th>상태</th>
              <th>관리</th>
            </tr>
          </thead>
          <tbody>
            {% for blocked_ip in page_obj %}
              <tr>
                <td><strong>{{ blocked_ip.ip_address }}</strong></td>
                <td>{{ blocked_ip.reason|default:"-" }}</td>
                <td>
                  {% if blocked_ip.blocked_by %}
                    {{ blocked_ip.blocked_by.username }}
                  {% else %}
                    <span class="text-muted">시스템</span>
                  {% endif %}
                </td>
                <td>{{ blocked_ip.created_at|date:"Y-m-d H:i" }}</td>
                <td>
                  {% if blocked_ip.is_active %}
                    <span class="badge bg-danger">차단 중</span>
                  {% else %}
                    <span class="badge bg-secondary">해제됨</span>
                  {% endif %}
                </td>
                <td>
                  {% if blocked_ip.is_active %}
                    <form method="post" action="{% url 'common:admin_unblock_ip' blocked_ip.id %}"
                          style="display: inline;"
                          onsubmit="return confirm('{{ blocked_ip.ip_address }}의 차단을 해제하시겠습니까?');">
                      {% csrf_token %}
                      <button type="submit" class="btn btn-sm btn-success">
                        <i class="fas fa-check me-1"></i>차단 해제
                      </button>
                    </form>
                  {% else %}
                    <span class="text-muted">-</span>
                  {% endif %}
                </td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="6" class="text-center text-muted py-4">
                  차단된 IP가 없습니다.
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- 페이지네이션 -->
      {% if page_obj.has_other_pages %}
        <nav aria-label="Page navigation" class="mt-4">
          <ul class="pagination justify-content-center">
            {% if page_obj.has_previous %}
              <li class="page-item">
                <a class="page-link" href="?page=1&status={{ status_filter }}&search={{ search_query }}">처음</a>
              </li>
              <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.previous_page_number }}&status={{ status_filter }}&search={{ search_query }}">이전</a>
              </li>
            {% else %}
              <li class="page-item disabled">
                <span class="page-link">처음</span>
              </li>
              <li class="page-item disabled">
                <span class="page-link">이전</span>
              </li>
            {% endif %}

            <li class="page-item active">
              <span class="page-link">
                {{ page_obj.number }} / {{ page_obj.paginator.num_pages }}
              </span>
            </li>

            {% if page_obj.has_next %}
              <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.next_page_number }}&status={{ status_filter }}&search={{ search_query }}">다음</a>
              </li>
              <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}&status={{ status_filter }}&search={{ search_query }}">마지막</a>
              </li>
            {% else %}
              <li class="page-item disabled">
                <span class="page-link">다음</span>
              </li>
              <li class="page-item disabled">
                <span class="page-link">마지막</span>
              </li>
            {% endif %}
          </ul>
        </nav>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}
