{% extends 'base_mobile.html' %}
{% load static %}
{% load common_tags %}

{% block title %}프로필 설정 - 테크창{% endblock %}

{% block extra_css %}
<style>
.m-profile-avatar {
    width: 80px; height: 80px;
    border-radius: 50%;
    object-fit: cover;
    border: 3px solid var(--accent-primary, #3b82f6);
}
.m-profile-avatar-placeholder {
    width: 80px; height: 80px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea, #764ba2);
    display: flex; align-items: center; justify-content: center;
    color: #fff; font-size: 2rem; font-weight: 800;
    flex-shrink: 0;
}
.m-section-card {
    background: var(--bg-primary, #fff);
    border-radius: 16px;
    padding: 16px;
    margin: 0 16px 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,.06);
}
.m-section-title {
    font-size: 0.875rem;
    font-weight: 700;
    color: var(--text-tertiary, #9ca3af);
    text-transform: uppercase;
    letter-spacing: .05em;
    margin-bottom: 12px;
}
.m-form-group { margin-bottom: 14px; }
.m-form-label { display: block; font-size: 0.8125rem; font-weight: 600; color: var(--text-secondary, #6b7280); margin-bottom: 5px; }
.m-form-input {
    width: 100%;
    padding: 12px 14px;
    border: 1.5px solid var(--border-light, #e5e7eb);
    border-radius: 10px;
    font-size: 0.9375rem;
    color: var(--text-primary, #111);
    background: var(--bg-primary, #fff);
    outline: none;
    transition: border-color .2s;
}
.m-form-input:focus { border-color: var(--accent-primary, #3b82f6); }
.m-form-hint { font-size: 0.75rem; color: var(--text-tertiary, #9ca3af); margin-top: 4px; }
.m-btn-save {
    display: block; width: calc(100% - 32px); margin: 0 16px 12px;
    padding: 14px;
    background: var(--accent-primary, #3b82f6);
    color: #fff; border: none; border-radius: 12px;
    font-size: 1rem; font-weight: 700; cursor: pointer;
}
.m-btn-danger {
    display: block; width: calc(100% - 32px); margin: 0 16px 20px;
    padding: 12px;
    background: transparent;
    color: #ef4444; border: 1.5px solid #ef4444; border-radius: 12px;
    font-size: 0.9375rem; font-weight: 600; cursor: pointer; text-align: center;
    text-decoration: none;
}
.m-verify-badge {
    display: inline-flex; align-items: center; gap: 4px;
    padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600;
}
.m-verify-badge.verified { background: #d1fae5; color: #065f46; }
.m-verify-badge.unverified { background: #fef3c7; color: #92400e; }
</style>
{% endblock %}

{% block content %}
<!-- 프로필 헤더 -->
<div style="padding: 20px 16px 12px; display: flex; align-items: center; gap: 16px;">
    {% if profile.profile_image %}
    <img src="{{ profile.profile_image.url }}" class="m-profile-avatar" alt="프로필">
    {% else %}
    <div class="m-profile-avatar-placeholder">{{ user.username|slice:":1"|upper }}</div>
    {% endif %}
    <div>
        <div style="font-size:1.125rem;font-weight:800;">{{ user|display_name }}</div>
        <div style="font-size:0.8125rem;color:var(--text-secondary,#6b7280);">@{{ user.username }}</div>
        <div style="margin-top:4px;">
            {% if profile.is_email_verified %}
            <span class="m-verify-badge verified"><i class="fas fa-check-circle"></i> 이메일 인증됨</span>
            {% else %}
            <span class="m-verify-badge unverified"><i class="fas fa-exclamation-triangle"></i> 미인증</span>
            {% endif %}
        </div>
    </div>
</div>

{% if messages %}
<div style="padding: 0 16px 8px;">
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }} alert-dismissible" style="border-radius:12px;font-size:.875rem;">
        {{ message }}
        <button type="button" class="btn-close btn-sm" data-bs-dismiss="alert"></button>
    </div>
    {% endfor %}
</div>
{% endif %}

<form method="post" enctype="multipart/form-data">
    {% csrf_token %}

    {% if form.errors %}
    <div style="padding: 0 16px 8px;">
        <div class="alert alert-danger" style="border-radius:12px;font-size:.875rem;">
            {% for field in form %}{% for error in field.errors %}<div>{{ field.label }}: {{ error }}</div>{% endfor %}{% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- 기본 정보 -->
    <div class="m-section-card">
        <div class="m-section-title">기본 정보</div>
        <div class="m-form-group">
            <label class="m-form-label">사용자 이름</label>
            <input class="m-form-input" type="text" value="{{ user.username }}" disabled style="background:#f9fafb;color:#9ca3af;">
            <div class="m-form-hint">사용자 이름은 변경할 수 없습니다</div>
        </div>
        <div class="m-form-group">
            <label class="m-form-label" for="{{ form.nickname.id_for_label }}">닉네임</label>
            <input class="m-form-input" type="text"
                   name="{{ form.nickname.name }}" id="{{ form.nickname.id_for_label }}"
                   value="{{ form.nickname.value|default:'' }}"
                   placeholder="닉네임 (비어있으면 사용자명 표시)">
            <div class="m-form-hint">커뮤니티에서 표시될 이름입니다</div>
        </div>
    </div>

    <!-- 프로필 이미지 -->
    <div class="m-section-card">
        <div class="m-section-title">프로필 이미지</div>
        {% if profile.profile_image %}
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px;">
            <img src="{{ profile.profile_image.url }}" style="width:48px;height:48px;border-radius:50%;object-fit:cover;" alt="현재">
            <span style="font-size:0.8125rem;color:var(--text-secondary,#6b7280);">현재 이미지</span>
        </div>
        {% endif %}
        <input type="file" class="m-form-input" name="{{ form.profile_image.name }}"
               id="{{ form.profile_image.id_for_label }}" accept="image/*"
               style="padding:10px;">
        <div class="m-form-hint">JPG, PNG 파일 최대 5MB</div>
        {% if profile.profile_image %}
        <label style="display:flex;align-items:center;gap:8px;margin-top:10px;font-size:0.875rem;color:var(--text-secondary,#6b7280);">
            <input type="checkbox" name="{{ form.profile_image.name }}-clear"> 현재 이미지 삭제
        </label>
        {% endif %}
    </div>

    <!-- 이메일 인증 -->
    <div class="m-section-card">
        <div class="m-section-title">이메일 인증</div>
        {% if profile.is_email_verified %}
        <div style="display:flex;align-items:center;justify-content:space-between;">
            <div>
                <div style="font-size:0.875rem;font-weight:600;">{{ user.email }}</div>
                <div style="font-size:0.75rem;color:var(--text-tertiary,#9ca3af);">인증 완료</div>
            </div>
            <button type="button" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#emailChangeModal">변경</button>
        </div>
        {% else %}
        <p style="font-size:0.875rem;color:var(--text-secondary,#6b7280);margin-bottom:10px;">이메일을 인증하면 비밀번호 찾기 등의 기능을 이용할 수 있습니다.</p>
        <button type="button" class="btn btn-sm btn-primary w-100" data-bs-toggle="modal" data-bs-target="#emailVerifyModal">
            <i class="fas fa-envelope-open-text me-2"></i>이메일 인증하기
        </button>
        {% endif %}
    </div>

    <button type="submit" class="m-btn-save">
        <i class="fas fa-save me-2"></i>변경사항 저장
    </button>
</form>

<!-- 회원 탈퇴 -->
<a href="{% url 'common:account_delete' %}" class="m-btn-danger"
   onclick="return confirm('정말로 회원 탈퇴 페이지로 이동하시겠습니까?')">
    <i class="fas fa-user-times me-2"></i>회원 탈퇴
</a>

<!-- 이메일 인증 모달 -->
<div class="modal fade" id="emailVerifyModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="border-radius:16px;border:none;">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-envelope-open-text me-2"></i>이메일 인증</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="verifyStep1">
                    <div class="mb-3">
                        <label class="form-label">이메일 주소</label>
                        <input type="email" class="form-control" id="verifyEmail" value="{{ user.email }}" placeholder="your@email.com">
                    </div>
                    <button class="btn btn-primary w-100" onclick="sendVerificationCode('verify')">
                        <i class="fas fa-paper-plane me-2"></i>인증코드 발송
                    </button>
                </div>
                <div id="verifyStep2" style="display:none;">
                    <div class="alert alert-info"><i class="fas fa-info-circle me-2"></i><span id="verifyEmailDisplay"></span>로 코드 발송됨</div>
                    <div class="mb-3">
                        <label class="form-label">인증코드 (4자리)</label>
                        <input type="text" class="form-control" id="verifyCode" maxlength="4" placeholder="0000" inputmode="numeric">
                    </div>
                    <div class="d-grid gap-2">
                        <button class="btn btn-success" onclick="verifyCode('verify')"><i class="fas fa-check me-2"></i>인증 완료</button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="sendVerificationCode('verify')">재발송</button>
                    </div>
                </div>
                <div id="verifySuccess" style="display:none;">
                    <div class="alert alert-success text-center"><i class="fas fa-check-circle fa-2x mb-2 d-block"></i>이메일 인증 완료!</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 이메일 변경 모달 -->
<div class="modal fade" id="emailChangeModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="border-radius:16px;border:none;">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-edit me-2"></i>이메일 변경</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="changeStep1">
                    <div class="mb-3">
                        <label class="form-label">새 이메일 주소</label>
                        <input type="email" class="form-control" id="changeEmail" placeholder="새 이메일 주소">
                    </div>
                    <button class="btn btn-primary w-100" onclick="sendVerificationCode('change')">
                        <i class="fas fa-paper-plane me-2"></i>인증코드 발송
                    </button>
                </div>
                <div id="changeStep2" style="display:none;">
                    <div class="alert alert-info"><span id="changeEmailDisplay"></span>로 코드 발송됨</div>
                    <div class="mb-3">
                        <label class="form-label">인증코드 (4자리)</label>
                        <input type="text" class="form-control" id="changeCode" maxlength="4" placeholder="0000" inputmode="numeric">
                    </div>
                    <div class="d-grid gap-2">
                        <button class="btn btn-success" onclick="verifyCode('change')"><i class="fas fa-check me-2"></i>변경 완료</button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="sendVerificationCode('change')">재발송</button>
                    </div>
                </div>
                <div id="changeSuccess" style="display:none;">
                    <div class="alert alert-success text-center"><i class="fas fa-check-circle fa-2x mb-2 d-block"></i>이메일 변경 완료!</div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block script %}
<script>
function sendVerificationCode(type) {
    const emailInput = type === 'verify' ? document.getElementById('verifyEmail') : document.getElementById('changeEmail');
    const email = emailInput.value.trim();
    if (!email) { alert('이메일을 입력해주세요.'); return; }

    fetch('/common/send-verification-email/', {
        method: 'POST',
        headers: {'Content-Type': 'application/json', 'X-CSRFToken': window.CSRF_TOKEN},
        body: JSON.stringify({email: email, type: type})
    }).then(r => r.json()).then(data => {
        if (data.success) {
            if (type === 'verify') {
                document.getElementById('verifyEmailDisplay').textContent = email;
                document.getElementById('verifyStep1').style.display = 'none';
                document.getElementById('verifyStep2').style.display = 'block';
            } else {
                document.getElementById('changeEmailDisplay').textContent = email;
                document.getElementById('changeStep1').style.display = 'none';
                document.getElementById('changeStep2').style.display = 'block';
            }
        } else {
            alert(data.error || '코드 발송에 실패했습니다.');
        }
    }).catch(() => alert('오류가 발생했습니다.'));
}

function verifyCode(type) {
    const codeInput = type === 'verify' ? document.getElementById('verifyCode') : document.getElementById('changeCode');
    const emailInput = type === 'verify' ? document.getElementById('verifyEmail') : document.getElementById('changeEmail');
    const code = codeInput.value.trim();
    const email = emailInput.value.trim();
    if (!code) { alert('인증코드를 입력해주세요.'); return; }

    fetch('/common/verify-email-code/', {
        method: 'POST',
        headers: {'Content-Type': 'application/json', 'X-CSRFToken': window.CSRF_TOKEN},
        body: JSON.stringify({email: email, code: code, type: type})
    }).then(r => r.json()).then(data => {
        if (data.success) {
            const step = type === 'verify' ? 'verifyStep2' : 'changeStep2';
            const success = type === 'verify' ? 'verifySuccess' : 'changeSuccess';
            document.getElementById(step).style.display = 'none';
            document.getElementById(success).style.display = 'block';
            setTimeout(() => location.reload(), 1500);
        } else {
            alert(data.error || '인증에 실패했습니다.');
        }
    }).catch(() => alert('오류가 발생했습니다.'));
}
</script>
{% endblock %}
