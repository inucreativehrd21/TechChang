{% extends 'base.html' %}
{% load static %}
{% load common_tags %}

{% block title %}프로필 설정 - PyBo{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0">
                        <i class="fas fa-user-edit me-2"></i>프로필 설정
                    </h4>
                </div>
                <div class="card-body">
                    <!-- 현재 프로필 정보 -->
                    <div class="row mb-4">
                        <div class="col-md-3 text-center">
                            {% if profile.profile_image %}
                            <img src="{{ profile.profile_image.url }}" alt="프로필 이미지" 
                                 class="rounded-circle mb-3" style="width: 100px; height: 100px; object-fit: cover;">
                            {% else %}
                            <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center text-white mb-3 mx-auto" 
                                 style="width: 100px; height: 100px; font-size: 2.5rem; font-weight: bold;">
                                {{ user.username|slice:":1"|upper }}
                            </div>
                            {% endif %}
                            <h5>{{ user|display_name }}</h5>
                            <p class="text-muted">{{ user.email|default:"이메일 미설정" }}</p>
                        </div>
                        <div class="col-md-9">
                            <div class="row">
                                <div class="col-sm-6">
                                    <strong>사용자명:</strong> {{ user.username }}
                                </div>
                                <div class="col-sm-6">
                                    <strong>가입일:</strong> {{ user.date_joined|date:"Y-m-d" }}
                                </div>
                            </div>
                        </div>
                    </div>

                    <hr>

                    <!-- 이메일 인증 상태 -->
                    <div class="alert {% if profile.is_email_verified %}alert-success{% else %}alert-warning{% endif %} mb-4">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1">
                                    {% if profile.is_email_verified %}
                                    <i class="fas fa-check-circle me-2"></i>이메일 인증 완료
                                    {% else %}
                                    <i class="fas fa-exclamation-triangle me-2"></i>이메일 인증 필요
                                    {% endif %}
                                </h6>
                                <p class="mb-0 small">
                                    {% if profile.is_email_verified %}
                                    현재 이메일: <strong>{{ user.email }}</strong>
                                    {% else %}
                                    이메일 인증이 필요합니다. 비밀번호 찾기 등의 기능을 이용하려면 이메일 인증을 완료해주세요.
                                    {% endif %}
                                </p>
                            </div>
                            <div>
                                {% if not profile.is_email_verified %}
                                <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#emailVerifyModal">
                                    <i class="fas fa-envelope-open-text me-1"></i>이메일 인증하기
                                </button>
                                {% else %}
                                <button type="button" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#emailChangeModal">
                                    <i class="fas fa-edit me-1"></i>이메일 변경
                                </button>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <hr>

                    <!-- 프로필 설정 폼 -->
                    <form method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        
                        {% if messages %}
                        {% for message in messages %}
                        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                            <i class="fas fa-check-circle me-2"></i>
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                        {% endfor %}
                        {% endif %}
                        
                        {% if form.errors %}
                        <div class="alert alert-danger">
                            {% for field in form %}
                                {% for error in field.errors %}
                                    <div><strong>{{ field.label }}:</strong> {{ error }}</div>
                                {% endfor %}
                            {% endfor %}
                        </div>
                        {% endif %}
                        
                        <div class="mb-3">
                            <label for="{{ form.nickname.id_for_label }}" class="form-label">
                                <i class="fas fa-user me-1"></i>닉네임
                            </label>
                            <input type="text" name="{{ form.nickname.name }}" 
                                   class="form-control" id="{{ form.nickname.id_for_label }}" 
                                   value="{{ form.nickname.value|default:'' }}"
                                   placeholder="닉네임을 입력하세요 (비어있으면 사용자명 표시)">
                            <div class="form-text">닉네임을 설정하지 않으면 사용자명이 표시됩니다.</div>
                        </div>
                        
                        <div class="mb-4">
                            <label for="{{ form.profile_image.id_for_label }}" class="form-label">
                                <i class="fas fa-image me-1"></i>프로필 이미지
                            </label>
                            {% if profile.profile_image %}
                            <div class="mb-2">
                                <small class="text-muted">현재 이미지:</small>
                                <img src="{{ profile.profile_image.url }}" alt="현재 프로필 이미지" 
                                     class="ms-2 rounded" style="width: 50px; height: 50px; object-fit: cover;">
                            </div>
                            {% endif %}
                            <input type="file" name="{{ form.profile_image.name }}" 
                                   class="form-control" id="{{ form.profile_image.id_for_label }}" 
                                   accept="image/*">
                            {% if profile.profile_image %}
                            <div class="form-check mt-2">
                                <input type="checkbox" name="{{ form.profile_image.name }}-clear" 
                                       class="form-check-input" id="clear_profile_image">
                                <label class="form-check-label" for="clear_profile_image">
                                    현재 이미지 삭제
                                </label>
                            </div>
                            {% endif %}
                            <div class="form-text">JPG, PNG 파일을 업로드할 수 있습니다. 최대 5MB</div>
                        </div>
                        
                        <div class="d-flex justify-content-between align-items-center">
                            <a href="{% url 'community:index' %}" class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-left me-1"></i>취소
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-1"></i>변경사항 저장
                            </button>
                        </div>
                        
                        <!-- 위험한 작업 영역 -->
                        <hr class="my-4">
                        <div class="alert alert-warning">
                            <h6 class="alert-heading">
                                <i class="fas fa-exclamation-triangle me-2"></i>위험한 작업
                            </h6>
                            <p class="mb-0">아래 작업은 되돌릴 수 없습니다. 신중하게 결정해주세요.</p>
                        </div>
                        <div class="text-center">
                            <a href="{% url 'common:account_delete' %}" 
                               class="btn btn-outline-danger"
                               onclick="return confirm('정말로 회원 탈퇴 페이지로 이동하시겠습니까?')">
                                <i class="fas fa-user-times me-1"></i>회원 탈퇴
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 이메일 인증 모달 -->
<div class="modal fade" id="emailVerifyModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-envelope-open-text me-2"></i>이메일 인증
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="verifyStep1">
                    <p class="mb-3">현재 이메일: <strong id="currentEmail">{{ user.email|default:"미설정" }}</strong></p>
                    <div class="mb-3">
                        <label for="verifyEmail" class="form-label">이메일 주소</label>
                        <input type="email" class="form-control" id="verifyEmail" value="{{ user.email }}" placeholder="your@email.com" required>
                        <div class="form-text">이메일을 변경하려면 새 이메일을 입력하세요.</div>
                    </div>
                    <button type="button" class="btn btn-primary w-100" onclick="sendVerificationCode('verify')">
                        <i class="fas fa-paper-plane me-2"></i>인증코드 발송
                    </button>
                </div>
                <div id="verifyStep2" style="display: none;">
                    <div class="alert alert-info mb-3">
                        <i class="fas fa-info-circle me-2"></i>
                        <span id="verifyEmailDisplay"></span>로 인증코드가 발송되었습니다.
                    </div>
                    <div class="mb-3">
                        <label for="verifyCode" class="form-label">인증코드 (4자리)</label>
                        <input type="text" class="form-control" id="verifyCode" maxlength="4" placeholder="0000" required>
                    </div>
                    <div class="d-grid gap-2">
                        <button type="button" class="btn btn-success" onclick="verifyCode('verify')">
                            <i class="fas fa-check me-2"></i>인증 완료
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="sendVerificationCode('verify')">
                            <i class="fas fa-redo me-2"></i>인증코드 재발송
                        </button>
                    </div>
                </div>
                <div id="verifySuccess" style="display: none;">
                    <div class="alert alert-success text-center">
                        <i class="fas fa-check-circle fa-3x mb-3"></i>
                        <h5>이메일 인증 완료!</h5>
                        <p class="mb-0">이메일 인증이 성공적으로 완료되었습니다.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 이메일 변경 모달 -->
<div class="modal fade" id="emailChangeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-edit me-2"></i>이메일 변경
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="changeStep1">
                    <p class="mb-3">현재 이메일: <strong>{{ user.email }}</strong></p>
                    <div class="mb-3">
                        <label for="newEmail" class="form-label">새 이메일 주소</label>
                        <input type="email" class="form-control" id="newEmail" placeholder="newemail@example.com" required>
                    </div>
                    <button type="button" class="btn btn-primary w-100" onclick="sendVerificationCode('change')">
                        <i class="fas fa-paper-plane me-2"></i>인증코드 발송
                    </button>
                </div>
                <div id="changeStep2" style="display: none;">
                    <div class="alert alert-info mb-3">
                        <i class="fas fa-info-circle me-2"></i>
                        <span id="changeEmailDisplay"></span>로 인증코드가 발송되었습니다.
                    </div>
                    <div class="mb-3">
                        <label for="changeCode" class="form-label">인증코드 (4자리)</label>
                        <input type="text" class="form-control" id="changeCode" maxlength="4" placeholder="0000" required>
                    </div>
                    <div class="d-grid gap-2">
                        <button type="button" class="btn btn-success" onclick="verifyCode('change')">
                            <i class="fas fa-check me-2"></i>이메일 변경 완료
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="sendVerificationCode('change')">
                            <i class="fas fa-redo me-2"></i>인증코드 재발송
                        </button>
                    </div>
                </div>
                <div id="changeSuccess" style="display: none;">
                    <div class="alert alert-success text-center">
                        <i class="fas fa-check-circle fa-3x mb-3"></i>
                        <h5>이메일 변경 완료!</h5>
                        <p class="mb-0">이메일이 성공적으로 변경되었습니다.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let currentMode = '';
let currentEmail = '';

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function sendVerificationCode(mode) {
    currentMode = mode;
    let email;

    if (mode === 'verify') {
        email = document.getElementById('verifyEmail').value;
    } else {
        email = document.getElementById('newEmail').value;
    }

    if (!email || !email.includes('@')) {
        alert('올바른 이메일 주소를 입력해주세요.');
        return;
    }

    currentEmail = email;

    fetch('/common/send-verification-email/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ email: email })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            if (mode === 'verify') {
                document.getElementById('verifyStep1').style.display = 'none';
                document.getElementById('verifyStep2').style.display = 'block';
                document.getElementById('verifyEmailDisplay').textContent = email;
            } else {
                document.getElementById('changeStep1').style.display = 'none';
                document.getElementById('changeStep2').style.display = 'block';
                document.getElementById('changeEmailDisplay').textContent = email;
            }
        } else {
            alert('오류: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('인증코드 발송 중 오류가 발생했습니다.');
    });
}

function verifyCode(mode) {
    let code;

    if (mode === 'verify') {
        code = document.getElementById('verifyCode').value;
    } else {
        code = document.getElementById('changeCode').value;
    }

    if (!code || code.length !== 4) {
        alert('4자리 인증코드를 입력해주세요.');
        return;
    }

    fetch('/common/verify-email-change/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            email: currentEmail,
            code: code
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            if (mode === 'verify') {
                document.getElementById('verifyStep2').style.display = 'none';
                document.getElementById('verifySuccess').style.display = 'block';
            } else {
                document.getElementById('changeStep2').style.display = 'none';
                document.getElementById('changeSuccess').style.display = 'block';
            }
            setTimeout(() => {
                location.reload();
            }, 2000);
        } else {
            alert('오류: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('인증 처리 중 오류가 발생했습니다.');
    });
}
</script>
{% endblock %}