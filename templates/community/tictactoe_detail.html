{% extends 'base.html' %}
{% load common_tags %}

{% block title %}{{ game.title }} - í‹±íƒí† {% endblock %}

{% block extra_css %}{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <!-- ê²Œì„ í—¤ë” -->
            <div class="card mb-4 card-glow card-lift fade-in-up">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0"><i class="fas fa-gamepad me-2"></i>{{ game.title }}</h3>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="player-info {% if game.status == 'playing' and game.current_turn == 'X' %}active{% endif %}" id="playerXInfo">
                                <h5>
                                    <span class="badge bg-danger me-2">X</span>
                                    {{ game.player_x.username }}
                                    {% if is_player_x %}<small class="text-muted">(ë‚˜)</small>{% endif %}
                                </h5>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="player-info {% if game.status == 'playing' and game.current_turn == 'O' %}active{% endif %}" id="playerOInfo">
                                <h5>
                                    <span class="badge bg-info me-2">O</span>
                                    {% if game.player_o %}
                                        {{ game.player_o.username }}
                                        {% if is_player_o %}<small class="text-muted">(ë‚˜)</small>{% endif %}
                                    {% else %}
                                        <span class="text-muted">ëŒ€ê¸°ì¤‘...</span>
                                    {% endif %}
                                </h5>
                            </div>
                        </div>
                    </div>

                    {% if game.status == 'waiting' and can_join %}
                    <div class="text-center mt-3">
                        <button class="btn btn-success btn-lg btn-ripple" onclick="joinGame()">
                            <i class="fas fa-user-plus me-2"></i>ê²Œì„ ì°¸ê°€í•˜ê¸°
                        </button>
                    </div>
                    {% endif %}

                    {% if game.status == 'waiting' and not can_join and not game.player_o %}
                    <div class="alert alert-info text-center mt-3">
                        <i class="fas fa-clock me-2"></i>ìƒëŒ€ë°©ì„ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- ê²Œì„ ë³´ë“œ -->
            <div class="card mb-4 card-lift fade-in-up animate-delay-200">
                <div class="card-body">
                    <div class="tictactoe-board" id="gameBoard">
                        {% for row in game.board_state %}
                            {% for cell in row %}
                                <button class="tictactoe-cell
                                    {% if cell == 'X' %}cell-x{% elif cell == 'O' %}cell-o{% endif %}"
                                    data-row="{{ forloop.parentloop.counter0 }}"
                                    data-col="{{ forloop.counter0 }}"
                                    onclick="makeMove({{ forloop.parentloop.counter0 }}, {{ forloop.counter0 }})"
                                    {% if game.status != 'playing' or cell %}disabled{% endif %}>
                                    {{ cell }}
                                </button>
                            {% endfor %}
                        {% endfor %}
                    </div>
                </div>
            </div>

            <div class="text-center">
                <a href="{% url 'community:tictactoe_list' %}" class="btn btn-outline-secondary btn-ripple">
                    <i class="fas fa-arrow-left me-2"></i>ëª©ë¡ìœ¼ë¡œ
                </a>
            </div>
        </div>
    </div>
</div>

<!-- ìŠ¹ì ë°°ë„ˆ -->
<div class="overlay" id="overlay"></div>
<div class="winner-banner scale-in-center" id="winnerBanner" style="display: none;">
    <div class="text-center">
        <h1 id="winnerText"></h1>
        <button class="btn btn-primary mt-3" onclick="location.reload()">
            <i class="fas fa-redo me-2"></i>ë‹¤ì‹œí•˜ê¸°
        </button>
    </div>
</div>

<input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">

<script>
const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
const gameId = {{ game.id }};
const isPlayerX = {{ is_player_x|yesno:"true,false" }};
const isPlayerO = {{ is_player_o|yesno:"true,false" }};
let currentTurn = '{{ game.current_turn }}';
let gameStatus = '{{ game.status }}';

// === WebSocket ì—°ê²° ===
let gameSocket = null;

function initWebSocket() {
    const wsScheme = window.location.protocol === 'https:' ? 'wss' : 'ws';
    const wsPath = `${wsScheme}://${window.location.host}/ws/tictactoe/${gameId}/`;

    console.log('[TicTacToe WS] ì—°ê²° ì‹œë„:', wsPath);

    gameSocket = new WebSocket(wsPath);

    gameSocket.onopen = function(e) {
        console.log('[TicTacToe WS] âœ… ì—°ê²° ì„±ê³µ!');
    };

    gameSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        console.log('[TicTacToe WS] ğŸ“¨ ë©”ì‹œì§€:', data);

        if (data.type === 'delta_update') {
            handleDeltaUpdate(data);
        } else if (data.type === 'player_connected') {
            showNotification(`${data.username}ë‹˜ì´ ì ‘ì†í–ˆìŠµë‹ˆë‹¤`, 'info');
        }
    };

    gameSocket.onclose = function(e) {
        console.log('[TicTacToe WS] ì—°ê²° ì¢…ë£Œ');
    };

    gameSocket.onerror = function(e) {
        console.error('[TicTacToe WS] ì˜¤ë¥˜:', e);
    };
}

// === Delta Update ì²˜ë¦¬ ===
function handleDeltaUpdate(data) {
    const action = data.action;
    const payload = data.data;

    if (action === 'move') {
        // ìˆ˜ ë‘ê¸° - ì¦‰ì‹œ UI ì—…ë°ì´íŠ¸
        const cell = document.querySelector(`[data-row="${payload.row}"][data-col="${payload.col}"]`);
        if (cell) {
            cell.textContent = payload.mark;
            cell.classList.add(payload.mark === 'X' ? 'cell-x' : 'cell-o');
            cell.disabled = true;
        }

        // í„´ ë³€ê²½
        currentTurn = payload.next_turn;
        updateTurnDisplay();
        updateBoardState();

    } else if (action === 'game_over') {
        // ê²Œì„ ì¢…ë£Œ
        const cell = document.querySelector(`[data-row="${payload.row}"][data-col="${payload.col}"]`);
        if (cell) {
            cell.textContent = payload.mark;
            cell.classList.add(payload.mark === 'X' ? 'cell-x' : 'cell-o');
            cell.disabled = true;
        }

        // ëª¨ë“  ì…€ ë¹„í™œì„±í™”
        document.querySelectorAll('.tictactoe-cell').forEach(c => c.disabled = true);

        if (payload.draw) {
            showWinner('ë¬´ìŠ¹ë¶€!', '#95a5a6');
        } else {
            const winnerMark = payload.winner;
            showWinner(`${winnerMark} ìŠ¹ë¦¬!`, winnerMark === 'X' ? '#e74c3c' : '#3498db');
        }

    } else if (action === 'game_started') {
        showNotification('ê²Œì„ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
        setTimeout(() => location.reload(), 1000);
    }
}

function updateTurnDisplay() {
    const playerXInfo = document.getElementById('playerXInfo');
    const playerOInfo = document.getElementById('playerOInfo');

    if (currentTurn === 'X') {
        playerXInfo.classList.add('active');
        playerOInfo.classList.remove('active');
    } else {
        playerXInfo.classList.remove('active');
        playerOInfo.classList.add('active');
    }
}

function updateBoardState() {
    const myTurn = (currentTurn === 'X' && isPlayerX) || (currentTurn === 'O' && isPlayerO);

    document.querySelectorAll('.tictactoe-cell').forEach(cell => {
        if (!cell.textContent && gameStatus === 'playing') {
            cell.disabled = !myTurn;
        }
    });
}

function joinGame() {
    fetch(`/pybo/tictactoe/${gameId}/join/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken,
            'Content-Type': 'application/json'
        }
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            showNotification(data.message, 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showNotification(data.message, 'error');
        }
    });
}

function makeMove(row, col) {
    // ë‚´ í„´ì¸ì§€ í™•ì¸
    const myTurn = (currentTurn === 'X' && isPlayerX) || (currentTurn === 'O' && isPlayerO);
    if (!myTurn) {
        showNotification('ë‹¹ì‹ ì˜ í„´ì´ ì•„ë‹™ë‹ˆë‹¤!', 'warning');
        return;
    }

    fetch(`/pybo/tictactoe/${gameId}/move/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': csrfToken
        },
        body: new URLSearchParams({ row, col })
    })
    .then(r => r.json())
    .then(data => {
        if (!data.success) {
            showNotification(data.message, 'error');
        }
        // ì„±ê³µ ì‹œ WebSocketì´ UIë¥¼ ì—…ë°ì´íŠ¸í•¨
    });
}

function showWinner(text, color) {
    const banner = document.getElementById('winnerBanner');
    const overlay = document.getElementById('overlay');
    const winnerText = document.getElementById('winnerText');

    winnerText.textContent = text;
    winnerText.style.color = color;
    banner.style.display = 'block';
    overlay.classList.add('show');
}

function showNotification(message, type) {
    // ê°„ë‹¨í•œ ì•Œë¦¼ (ê¸°ì¡´ í•¨ìˆ˜ í™œìš©)
    alert(message);
}

// ì´ˆê¸°í™”
if (gameStatus === 'playing') {
    initWebSocket();
    updateBoardState();
}
</script>
{% endblock %}
